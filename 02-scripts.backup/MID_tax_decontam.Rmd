---
title: "MID/CMB, Radcliffe, Kilteasheen, Iberian medieval calculus MALT decontam"
author: "Irina Velsko"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
    github_document:
        fig_width: 8
        fig_height: 6
        toc: true
---

```{r load_libraries, echo = F, message = F}
library(knitr)
library(decontam)
library(data.table)
library(janitor)
library(tidyverse)
opts_chunk$set(echo=F, warning=F, message=F, dpi=150)
```

Set the working directory of the notebook to the parent directory of the 
notebook itself.  

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

```{r load_data}
mid_raw <- fread("./05-results.backup/MID_malt_bactarchhomo2018_comparison-species.txt")
radcliffe_raw <- fread("./05-results.backup/Radcliffe_pfuT_comparison-species.txt")
kilteasheen_raw <- fread("./05-results.backup/Kilteasheen_comparison-species.txt")
iberian_raw <- fread("./05-results.backup/iberian_medieval_malt_species_raw.tsv")
mod_raw <- fread("./05-results.backup/mod_malt_species_raw.tsv")


all_raw <- mid_raw %>%
  full_join(., radcliffe_raw) %>%
  full_join(., kilteasheen_raw) %>%
  full_join(., iberian_raw) %>%
  full_join(., mod_raw)


# clean the file names
all_raw <- rename(all_raw, Species = `#Datasets`)
colnames(all_raw) <- gsub(".unmapped","", colnames(all_raw))
colnames(all_raw) <- gsub("MeganServer::","", colnames(all_raw))

# remove human and unassigned reads, convert NA to 0, and remove the 8 MID samples with no metadata
all_raw <- all_raw %>% 
  filter(!str_detect(Species, "Homo sapiens|Not assigned")) %>%
  replace(is.na(.), 0) %>%
  # these samples have no metadata
  select(-c("MID025.A0101","MID033.A0101","MID052.A0101","MID056.A0101","MID065.A0101","MID068.A0101","MID076.A0101","MID078.A0101")) %>%
  # remove Radcliffe soil and dentin
  select(-c("CSS","CSD")) %>%
  # remove any taxa that are not present in the remaining samples
  adorn_totals(where = "col") %>%
  filter(Total > 0) %>%
  select(-Total) %>%
  arrange(Species)

```

```{r}
metadata <- fread("00-documentation.backup/MID_analysis_metadata.tsv") %>%
  select(Site, Library_ID, Sample_or_Control, `DNA_molecules_per_library_x10^6`) %>%
  full_join(., fread("./00-documentation.backup/radcliffe_pfuT_metadata.tsv") %>%
            select(Site, Library_ID, Sample_or_Control)) %>%
  full_join(., fread("./00-documentation.backup/kilteasheen_metadata.tsv") %>%
            select(Site, Library_ID, Sample_or_Control, `DNA_molecules_per_library_x10^6`)) %>%
  full_join(., fread("./00-documentation.backup/iberian_medieval_metadata.tsv") %>%
            select(Site, Library_ID, Sample_or_Control, `DNA_molecules_per_library_x10^6`)) %>%
  full_join(., fread("./00-documentation.backup/mod_metadata.tsv") %>%
            select(Site, Library_ID, Sample_or_Control, `DNA_molecules_per_library_x10^6`))

#set the columns of interest to factors
metadata <- metadata %>%
  as_tibble() %>%
  mutate(Site = fct_relevel(Site, "MID","CMB","Radcliffe","Kilteasheen","ELR",
                                "IVE","Extraction_blank","Library_blank"),
         Sample_or_Control = fct_relevel(Sample_or_Control, "Sample", "Control"))

```


```{r pca_plotting_functions}
# plotting PCA with colored dots
plot_pca <- function(df, pc1, pc2, metadata_group) {
    metadata_group_colors <- get(paste(metadata_group, "_colors", sep = ""))
    metadata_group_shapes <- get(paste(metadata_group, "_shapes", sep = ""))

    exp_var <- paste0(round(df$explained_variance * 100, 2), "%")
    df_X <- df$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("Library_ID") %>%
              inner_join(metadata %>%
                           select(Library_ID, Site, Sample_or_Control), by = "Library_ID")
    
    metadata_group = df_X[[metadata_group]]
    
                       if (pc1 == 'PC1') {
                           pc1 <- df_X$PC1
                           exp_var_pc1 <- exp_var[1]
                           xaxis <- c("PC1")
                       }  else if (pc1 == 'PC2') {
                           pc1 <- df_X$PC2
                           exp_var_pc1 <- exp_var[2]
                           xaxis <- c("PC2")
                       } else if (pc1 == 'PC3') {
                           pc1 <- df_X$PC3
                           exp_var_pc1 <- exp_var[3]
                           xaxis <- c("PC3")
                       }

                       if (pc2 == 'PC1') {
                           pc2 <- df_X$PC1
                           exp_var_pc2 <- exp_var[1]
                           yaxis <- c("PC1")
                       }  else if (pc2 == 'PC2') {
                           pc2 <- df_X$PC2
                           exp_var_pc2 <- exp_var[2]
                           yaxis <- c("PC2")
                       } else if (pc2 == 'PC3') {
                           pc2 <- df_X$PC3
                           exp_var_pc2 <- exp_var[3]
                           yaxis <- c("PC3")
                       }

    pca_plot <- ggplot(df_X, aes(pc1, pc2, colour = metadata_group, shape = metadata_group)) +
                        geom_point(size = 4) +
                        scale_colour_manual(values = metadata_group_colors) +
                        scale_shape_manual(values = metadata_group_shapes) +
                        # stat_ellipse() +
                        xlab(paste(xaxis, " - ", exp_var_pc1)) +
                        ylab(paste(yaxis, " - ", exp_var_pc2)) +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

    return(pca_plot)
}

# this function plots the PCA with the sample names instead of points
plot_pca_names <- function(df, pc1, pc2, metadata_group) {
    metadata_group_colors <- get(paste(metadata_group, "_colors", sep = ""))

    exp_var <- paste0(round(df$explained_variance * 100, 2), "%")
    df_X <- df$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("Library_ID") %>%
              inner_join(metadata %>%
                           select(Library_ID, Site, Sample_or_Control), by = "Library_ID")
    
    metadata_group = df_X[[metadata_group]]
    
                       if (pc1 == 'PC1') {
                           pc1 <- df_X$PC1
                           exp_var_pc1 <- exp_var[1]
                           xaxis <- c("PC1")
                       }  else if (pc1 == 'PC2') {
                           pc1 <- df_X$PC2
                           exp_var_pc1 <- exp_var[2]
                           xaxis <- c("PC2")
                       } else if (pc1 == 'PC3') {
                           pc1 <- df_X$PC3
                           exp_var_pc1 <- exp_var[3]
                           xaxis <- c("PC3")
                       }

                       if (pc2 == 'PC1') {
                           pc2 <- df_X$PC1
                           exp_var_pc2 <- exp_var[1]
                           yaxis <- c("PC1")
                       }  else if (pc2 == 'PC2') {
                           pc2 <- df_X$PC2
                           exp_var_pc2 <- exp_var[2]
                           yaxis <- c("PC2")
                       } else if (pc2 == 'PC3') {
                           pc2 <- df_X$PC3
                           exp_var_pc2 <- exp_var[3]
                           yaxis <- c("PC3")
                       }

    pca_plot_names <- ggplot(df_X, aes(pc1, pc2, colour = metadata_group)) +
                        geom_text(aes(label = Library_ID), size = 2) +
                        scale_colour_manual(values = metadata_group_colors) +
                        # stat_ellipse() +
                        xlab(paste(xaxis, " - ", exp_var_pc1)) +
                        ylab(paste(yaxis, " - ", exp_var_pc2)) +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

    return(pca_plot_names)
}

```


Before running decontam, let's plot the samples in a PCA to see if there are any that are clearly not good-quality
```{r raw_plot}

malt_species_raw <- all_raw %>%
  # select(matches("Species|MID")) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("Library_ID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.malt_species_pca <- mixOmics::tune.pca(malt_species_raw, logratio = 'CLR')
tune.malt_species_pca

# perform a PCA to see how the data cluster
malt_species.pca <- mixOmics::pca(malt_species_raw, ncomp = 3, logratio = 'CLR')
plot(malt_species.pca)

# define some colors
Sample_or_Control_colors = c("Blue", "Magenta")
Sample_or_Control_shapes = c(19,8)

plot_pca(malt_species.pca, "PC1", "PC2", "Sample_or_Control")
plot_pca_names(malt_species.pca,  "PC1", "PC2", "Sample_or_Control")

```

```{r outliers}
# these are the 3 blanks that "passed" the cuperdec cut-off
# and we can see they plot with samples in the PCA above
# the MID samples don't have metadata so won't be included
outliers <- c("EXB059.A2501","LIB058.A0103","LIB058.A0106","CSS","CSD") 
poor_samples <- fread("./05-results.backup/cuperdec_poor_samples.tsv") %>%
  pull(Sample)

```

Read in the DeepEvo table with ARS samples, to use as bone controls to hopefully
clean up more environmental taxa. From
`https://github.com/jfy133/Hominid_Calculus_Microbiome_Evolution/tree/master/06-additional_data_files/Data_R11_S12_MALTMEGANTables/`.
```{r}
ars_bone_sp <- fread("./05-results.backup/Evolution-Comparison_MEGAN_20190410-ex_absolute_species_prokaryotes_summarised_refseq.txt") %>%
  rename(Species = `#Datasets`) %>%
  column_to_rownames("Species") %>%
  select(matches("ARS")) %>%
  rownames_to_column("Species") %>%
# remove all species that aren't in the gut samples
  adorn_totals(where = "col") %>%
  filter(Total != 0) %>%
  select(-Total)

colnames(ars_bone_sp) <- gsub("_S0_L003_R1_001.fastq.combined.fq.prefixed.extractunmapped.bam","", colnames(ars_bone_sp))

```

```{r deep_evo_meta}
deep_evo_metadata <- fread("./00-documentation.backup/02-calculus_microbiome-deep_evolution-individualscontrolssources_metadata_20200219.tsv") %>%
  rename(Library_ID = `#SampleID`) %>%
  filter(str_detect(Library_ID, "ARS"))

ars_samples <- deep_evo_metadata %>%
  pull(Library_ID)
  
```

# Decontamination with Decontam Prevalence Method (CMB, MID, IVE, ELR, JAE, Radcliffe; Kilteasheen has to be frequency)
We want to know if there are any species that can be removed b/c they appear to
be contaminants. Use the package decontam to determine which species may be
contaminants. Prepare the matrix for decontam.


## All together
```{r decontam_data_prep}
# list out the samples that have all 0 or NA values to remove from the input matrix
# NA_filter_list <- metadata %>% filter((is.na(SumLibraryConcentration_copies_ul) | SumLibraryConcentration_copies_ul <= 0)) %>% select(Library_ID)

# remove NA value samples from the input data frame
malt_species.dataframe <- all_raw %>%
  filter(!str_detect(Species, "Not assigned|Homo sapiens")) %>%
  select(-one_of(outliers)) %>%
  select(-one_of(poor_samples)) %>%
  full_join(., ars_bone_sp) %>%
  replace(is.na(.), 0) %>%
  gather("Library_ID","Counts", 2:ncol(.)) %>%
  spread(Species,Counts) 
# %>%
#   anti_join(., NA_filter_list)

# make a matrix for decontam
malt_species.matrix <- data.matrix(malt_species.dataframe[2:ncol(malt_species.dataframe)])
rownames(malt_species.matrix) <- malt_species.dataframe$Library_ID

# make a metadata dataframe with the same NA-containing samples removed
metadata.decontam <- metadata %>%
  filter(!str_detect(Library_ID, poor_samples %>% str_c(collapse = "|"))) %>%
  # anti_join(., NA_filter_list, by = "Library_ID") %>%
  filter(!str_detect(Library_ID, outliers %>% str_c(collapse = "|"))) %>%
  filter(Library_ID != "LIB058.A0101") %>% # this sample is not in the metadata
  arrange(Library_ID) %>%
  distinct() %>%
  bind_rows(., deep_evo_metadata %>%
              mutate(Site = "Bone") %>%
              select(Site, Library_ID, Sample_or_Control)) %>%
  arrange(Site)

# metadata.decontam %>% select(Library_ID) %>%
#   anti_join(., malt_species.dataframe %>% select(Library_ID))

```

Try the prevalence method to compare. 
```{r decontam_prevalence, eval = F}
# Assign sample-type status to identify control samples
metadata.decontam$is.control <- metadata.decontam$Sample_or_Control=="Control"

#Try changing the probability threshold cut-off to see how many more or less are ID'd as contaminants
contam.prev.species <- isContaminant(malt_species.matrix, method="prevalence", 
                                 neg=metadata.decontam$is.control, 
                                 threshold = 0.8)

# Check number of contaminants
table(contam.prev.species$contaminant)

# List of contaminants
cont_prev_species_list <- contam.prev.species[which(contam.prev.species$contaminant=="TRUE"), ]

# Look at the histogram - does the probability threshold need to be changed?
ggplot(contam.prev.species, aes(x=p)) +
  geom_histogram(bins=100) +
  scale_y_log10() +
  ggtitle('Prevalence - Species')


```

## MID, CMB
```{r decontam_data_prep}
# list out the samples that have all 0 or NA values to remove from the input matrix
# NA_filter_list <- metadata %>% filter((is.na(SumLibraryConcentration_copies_ul) | SumLibraryConcentration_copies_ul <= 0)) %>% select(Library_ID)

colnames(mid_raw) <- gsub(".unmapped","", colnames(mid_raw))
colnames(mid_raw) <- gsub("MeganServer::","", colnames(mid_raw))

# remove NA value samples from the input data frame
malt_species_mid.dataframe <- mid_raw %>%
  rename(Species = `#Datasets`) %>%
  select(-one_of(outliers)) %>%
  select(-one_of(poor_samples)) %>%
  select(-c("MID025.A0101","MID033.A0101","MID052.A0101","MID056.A0101","MID065.A0101","MID068.A0101","MID076.A0101","MID078.A0101","EXB034.A2701")) %>% # no metadata
  full_join(., ars_bone_sp) %>%
  replace(is.na(.), 0) %>%
  filter(!str_detect(Species, "Not assigned|Homo sapiens")) %>%
  gather("Library_ID","Counts", 2:ncol(.)) %>%
  spread(Species,Counts) 
# %>%
#   anti_join(., NA_filter_list)

# make a matrix for decontam
malt_species_mid.matrix <- data.matrix(malt_species_mid.dataframe[2:ncol(malt_species_mid.dataframe)])
rownames(malt_species_mid.matrix) <- malt_species_mid.dataframe$Library_ID

# make a metadata dataframe with the same NA-containing samples removed
metadata_mid.decontam <- metadata %>%
  filter(!str_detect(Library_ID, poor_samples %>% str_c(collapse = "|"))) %>%
  # anti_join(., NA_filter_list, by = "Library_ID") %>%
  filter(!str_detect(Library_ID, outliers %>% str_c(collapse = "|"))) %>%
  filter(str_detect(Library_ID, "MID|CMB|EXB059|LIB058")) %>%
  # filter(!str_detect(Library_ID, "LIB058.A0101|EXB034.A2701") %>% # these samples are not in the metadata
  filter(!str_detect(Library_ID, "MID025.A0101|MID033.A0101|MID052.A0101|MID056.A0101|MID065.A0101|MID068.A0101|MID076.A0101|MID078.A0101|LIB058.A0101|EXB034.A2701")) %>%
  arrange(Library_ID) %>%
  distinct() %>%
  bind_rows(., deep_evo_metadata %>%
              mutate(Site = "Bone") %>%
              select(Site, Library_ID, Sample_or_Control, SumLibraryConcentration_copies_ul) %>%
              mutate(`DNA_molecules_per_library_x10^6` = SumLibraryConcentration_copies_ul / 1000000) %>%
              select(-SumLibraryConcentration_copies_ul)) %>%
  arrange(Site)

# metadata.decontam %>% select(Library_ID) %>%
#   anti_join(., malt_species.dataframe %>% select(Library_ID))

```

```{r decontam_prevalence}
# Assign sample-type status to identify control samples
metadata_mid.decontam$is.control <- metadata_mid.decontam$Sample_or_Control=="Control"

#Try changing the probability threshold cut-off to see how many more or less are ID'd as contaminants
contam_mid.prev.species <- isContaminant(malt_species_mid.matrix, method="prevalence", 
                                 neg=metadata_mid.decontam$is.control, 
                                 threshold = 0.8)

# Check number of contaminants
table(contam_mid.prev.species$contaminant)

# List of contaminants
cont_prev_species_list_mid <- contam_mid.prev.species[which(contam_mid.prev.species$contaminant=="TRUE"), ]

# Look at the histogram - does the probability threshold need to be changed?
ggplot(contam_mid.prev.species, aes(x=p)) +
  geom_histogram(bins=100) +
  scale_y_log10() +
  ggtitle('Prevalence - Species')


```

## Radcliffe
```{r decontam_data_prep}
# list out the samples that have all 0 or NA values to remove from the input matrix
# NA_filter_list <- metadata %>% filter((is.na(SumLibraryConcentration_copies_ul) | SumLibraryConcentration_copies_ul <= 0)) %>% select(Library_ID)

# remove NA value samples from the input data frame
malt_species_rad.dataframe <- radcliffe_raw %>%
  rename(Species = `#Datasets`) %>%
  select(-one_of(poor_samples)) %>%
  full_join(., ars_bone_sp) %>%
  replace(is.na(.), 0) %>%
  filter(!str_detect(Species, "Not assigned|Homo sapiens")) %>%
  gather("Library_ID","Counts", 2:ncol(.)) %>%
  spread(Species,Counts) 
# %>%
#   anti_join(., NA_filter_list)

# make a matrix for decontam
malt_species_rad.matrix <- data.matrix(malt_species_rad.dataframe[2:ncol(malt_species_rad.dataframe)])
rownames(malt_species_rad.matrix) <- malt_species_rad.dataframe$Library_ID

# make a metadata dataframe with the same NA-containing samples removed
metadata_rad.decontam <- metadata %>%
  filter(!str_detect(Library_ID, poor_samples %>% str_c(collapse = "|"))) %>%
  # anti_join(., NA_filter_list, by = "Library_ID") %>%
  filter(str_detect(Library_ID, "CS")) %>%
  filter(!str_detect(Library_ID, "CSD")) %>%
  arrange(Library_ID) %>%
  distinct() %>%
  bind_rows(., deep_evo_metadata %>%
              mutate(Site = "Bone") %>%
              select(Site, Library_ID, Sample_or_Control)) %>%
  arrange(Site)

# metadata.decontam %>% select(Library_ID) %>%
#   anti_join(., malt_species.dataframe %>% select(Library_ID))

```

All of the taxa identified in the Radcliffe data as contaminants are still
clearly oral taxa. I won't remove any of these species because I don't want to
remove true oral taxa
```{r decontam_prevalence}
# Assign sample-type status to identify control samples
metadata_rad.decontam$is.control <- metadata_rad.decontam$Sample_or_Control=="Control"

#Try changing the probability threshold cut-off to see how many more or less are ID'd as contaminants
contam_rad.prev.species <- isContaminant(malt_species_rad.matrix, method="prevalence", 
                                 neg=metadata_rad.decontam$is.control, 
                                 threshold = 0.8)

# Check number of contaminants
table(contam_rad.prev.species$contaminant)

# List of contaminants
cont_prev_species_list_rad <- contam_rad.prev.species[which(contam_rad.prev.species$contaminant=="TRUE"), ]

# Look at the histogram - does the probability threshold need to be changed?
ggplot(contam_rad.prev.species, aes(x=p)) +
  geom_histogram(bins=100) +
  scale_y_log10() +
  ggtitle('Prevalence - Species')


```

## Iberian medieval
```{r decontam_data_prep}
# list out the samples that have all 0 or NA values to remove from the input matrix
# NA_filter_list <- metadata %>% filter((is.na(SumLibraryConcentration_copies_ul) | SumLibraryConcentration_copies_ul <= 0)) %>% select(Library_ID)

colnames(iberian_raw) <- gsub(".unmapped","", colnames(iberian_raw))

# remove NA value samples from the input data frame
malt_species_iber.dataframe <- iberian_raw %>%
  rename(Species = `#Datasets`) %>%
  select(-one_of(outliers)) %>%
  select(-one_of(poor_samples)) %>%
  full_join(., ars_bone_sp) %>%
  replace(is.na(.), 0) %>%
  filter(!str_detect(Species, "Not assigned|Homo sapiens")) %>%
  gather("Library_ID","Counts", 2:ncol(.)) %>%
  spread(Species,Counts) 
# %>%
#   anti_join(., NA_filter_list)

# make a matrix for decontam
malt_species_iber.matrix <- data.matrix(malt_species_iber.dataframe[2:ncol(malt_species_iber.dataframe)])
rownames(malt_species_iber.matrix) <- malt_species_iber.dataframe$Library_ID

# make a metadata dataframe with the same NA-containing samples removed
metadata_iber.decontam <- metadata %>%
  filter(!str_detect(Library_ID, poor_samples %>% str_c(collapse = "|"))) %>%
  # anti_join(., NA_filter_list, by = "Library_ID") %>%
  filter(!str_detect(Library_ID, outliers %>% str_c(collapse = "|"))) %>%
  filter(str_detect(Library_ID, "ELR|IVE|EXB015|LIB007")) %>%
  arrange(Library_ID) %>%
  distinct() %>%
  bind_rows(., deep_evo_metadata %>%
              mutate(Site = "Bone") %>%
              select(Site, Library_ID, Sample_or_Control, SumLibraryConcentration_copies_ul) %>%
              mutate(`DNA_molecules_per_library_x10^6` = SumLibraryConcentration_copies_ul / 1000000) %>%
              select(-SumLibraryConcentration_copies_ul)) %>%
  arrange(Site) %>%
  filter(Site != "Jaen")

# metadata.decontam %>% select(Library_ID) %>%
#   anti_join(., malt_species.dataframe %>% select(Library_ID))

```

```{r decontam_prevalence}
# Assign sample-type status to identify control samples
metadata_iber.decontam$is.control <- metadata_iber.decontam$Sample_or_Control=="Control"

#Try changing the probability threshold cut-off to see how many more or less are ID'd as contaminants
contam_iber.prev.species <- isContaminant(malt_species_iber.matrix, method="prevalence", 
                                 neg=metadata_iber.decontam$is.control, 
                                 threshold = 0.98)

# Check number of contaminants
table(contam_iber.prev.species$contaminant)

# List of contaminants
cont_prev_species_list_iber <- contam_iber.prev.species[which(contam_iber.prev.species$contaminant=="TRUE"), ]

# Look at the histogram - does the probability threshold need to be changed?
ggplot(contam_iber.prev.species, aes(x=p)) +
  geom_histogram(bins=100) +
  scale_y_log10() +
  ggtitle('Prevalence - Species')


```


## JAE/VLC modern
The contaminant species here are always still oral taxa, so we won't remove any
as contaminants with decontam. We'll do it during analyses with abundance
filtering to remove low abundance species.
```{r decontam_data_prep}
# list out the samples that have all 0 or NA values to remove from the input matrix
# NA_filter_list <- metadata %>% filter((is.na(SumLibraryConcentration_copies_ul) | SumLibraryConcentration_copies_ul <= 0)) %>% select(Library_ID)

colnames(mod_raw) <- gsub(".unmapped","", colnames(mod_raw))

# remove NA value samples from the input data frame
malt_species_mod.dataframe <- mod_raw %>%
  rename(Species = `#Datasets`) %>%
  select(-one_of(outliers)) %>%
  select(-one_of(poor_samples)) %>%
  full_join(., ars_bone_sp) %>%
  replace(is.na(.), 0) %>%
  filter(!str_detect(Species, "Not assigned|Homo sapiens")) %>%
  gather("Library_ID","Counts", 2:ncol(.)) %>%
  spread(Species,Counts) 
# %>%
#   anti_join(., NA_filter_list)

# make a matrix for decontam
malt_species_mod.matrix <- data.matrix(malt_species_mod.dataframe[2:ncol(malt_species_mod.dataframe)])
rownames(malt_species_mod.matrix) <- malt_species_mod.dataframe$Library_ID

# make a metadata dataframe with the same NA-containing samples removed
metadata_mod.decontam <- metadata %>%
  filter(!str_detect(Library_ID, poor_samples %>% str_c(collapse = "|"))) %>%
  # anti_join(., NA_filter_list, by = "Library_ID") %>%
  filter(!str_detect(Library_ID, outliers %>% str_c(collapse = "|"))) %>%
  filter(str_detect(Library_ID, "JAE|VLC|EXB015.A2301|LIB007.A0119|EXB015.A2901|LIB007.A0124")) %>%
  arrange(Library_ID) %>%
  distinct() %>%
  bind_rows(., deep_evo_metadata %>%
              mutate(Site = "Bone") %>%
              select(Site, Library_ID, Sample_or_Control, SumLibraryConcentration_copies_ul) %>%
              mutate(`DNA_molecules_per_library_x10^6` = SumLibraryConcentration_copies_ul / 1000000) %>%
              select(-SumLibraryConcentration_copies_ul)) %>%
  arrange(Site)

# metadata.decontam %>% select(Library_ID) %>%
#   anti_join(., malt_species.dataframe %>% select(Library_ID))

```

```{r decontam_prevalence}
# Assign sample-type status to identify control samples
metadata_mod.decontam$is.control <- metadata_mod.decontam$Sample_or_Control=="Control"

#Try changing the probability threshold cut-off to see how many more or less are ID'd as contaminants
contam_mod.prev.species <- isContaminant(malt_species_mod.matrix, method="prevalence", 
                                 neg=metadata_mod.decontam$is.control, 
                                 threshold = 0.1)

# Check number of contaminants
table(contam_mod.prev.species$contaminant)

# List of contaminants
cont_prev_species_list_mod <- contam_mod.prev.species[which(contam_mod.prev.species$contaminant=="TRUE"), ]

# Look at the histogram - does the probability threshold need to be changed?
ggplot(contam_mod.prev.species, aes(x=p)) +
  geom_histogram(bins=100) +
  scale_y_log10() +
  ggtitle('Prevalence - Species')


```


## Kilteasheen
?? No controls available
Modified from Lena's file `02_Kilteasheen_decontam.Rmd`
```{r decontam_data_prep}
# list out the samples that have all 0 or NA values to remove from the input matrix
# NA_filter_list <- metadata_cuperdec_cleaned %>% 
#   filter((is.na(SumLibraryConcentration_copies_ul) | SumLibraryConcentration_copies_ul <= 0)) %>% 
#   select("#SampleID")

colnames(kilteasheen_raw) <- gsub(".unmapped","", colnames(kilteasheen_raw))

# remove NA value samples from the input data frame
malt_species_kil.dataframe <- kilteasheen_raw %>%
  rename(Species = `#Datasets`) %>%
  select(-one_of(outliers)) %>%
  select(-one_of(poor_samples)) %>%
  full_join(., ars_bone_sp) %>%
  replace(is.na(.), 0) %>%
  filter(!str_detect(Species, "Not assigned|Homo sapiens")) %>%
  gather("Library_ID","Counts", 2:ncol(.)) %>%
  spread(Species,Counts) 

# make a matrix for decontam
malt_species_kil.matrix <- data.matrix(malt_species_kil.dataframe[2:ncol(malt_species_kil.dataframe)])
rownames(malt_species_kil.matrix) <- malt_species_kil.dataframe$Library_ID

# make a metadata dataframe with the same NA-containing samples removed
metadata_kil <- fread("./00-documentation.backup/kilteasheen_metadata.tsv") %>%
            select(Site, Library_ID, Sample_or_Control, `DNA_molecules_per_library_x10^6`)

metadata_kil.decontam <- metadata_kil %>%
  filter(!str_detect(Library_ID, poor_samples %>% str_c(collapse = "|"))) %>%
  # anti_join(., NA_filter_list, by = "Library_ID") %>%
  filter(!str_detect(Library_ID, outliers %>% str_c(collapse = "|"))) %>%
  filter(str_detect(Library_ID, "KT")) %>%
  arrange(Library_ID) %>%
  distinct() %>%
  bind_rows(., deep_evo_metadata %>%
              mutate(Site = "Bone") %>%
              select(Site, Library_ID, Sample_or_Control, SumLibraryConcentration_copies_ul) %>%
              mutate(`DNA_molecules_per_library_x10^6` = SumLibraryConcentration_copies_ul / 1000000) %>%
              select(-SumLibraryConcentration_copies_ul)) %>%
  arrange(Site)

```

Frequency method
```{r decontam_frequency_kil}
# Check for contamination by frequency
contam_kil.freq.species <- isContaminant(malt_species_kil.matrix, method="frequency", 
                                 conc=metadata_kil.decontam$`DNA_molecules_per_library_x10^6`, 
                                 threshold = 0.7)

# Print the # of species identified as contaminants by frequency
# Check number of contaminants
table(contam_kil.freq.species$contaminant)

# List of contaminants
cont_freq_species_list_kil <- contam_kil.freq.species[which(contam_kil.freq.species$contaminant=="TRUE"), ]

# Make a histogram to look at the distribution of the p-value (probability for classifying contaminants)

ggplot(contam_kil.freq.species, aes(x=p)) +
  geom_histogram(bins=100) +
  scale_y_log10() +
  ggtitle('Frequency - Species')

```


## Overlapping contaminant species
```{r}
# Overlapping contaminant species
cont_prev_species_list_mid %>% rownames_to_column("Species") %>%
  select(Species) %>% mutate(MID = "Yes") %>%
  full_join(., cont_prev_species_list_rad %>% rownames_to_column("Species") %>%
            select(Species) %>% mutate(Radcliffe = "Yes")) %>%
  full_join(., cont_prev_species_list_iber %>% rownames_to_column("Species") %>%
            select(Species) %>% mutate(Iberia = "Yes")) %>%
  replace(is.na(.), "No") %>%
  mutate(Shared = ifelse(MID == "Yes" & Radcliffe == "Yes" & Iberia == "Yes", "M-R-I",
                         ifelse(MID == "Yes"& Radcliffe == "Yes" & Iberia == "No", "M-R",
                                ifelse(MID == "Yes" & Iberia == "Yes" & Radcliffe == "No", "M-I",
                                       ifelse(Radcliffe == "Yes" & Iberia == "Yes" & MID == "No", "R-I", "Single"))))) %>%
  # filter(Shared == "R-I") %>%
  mutate(Shared = fct_relevel(Shared, "M-R-I","M-I","M-R","Single")) %>%
  arrange(Shared) %>%
  group_by(Shared) %>%
  count()

# the majority of the identified contaminants are shared across all groups

```


The Kileasheen samples have no associated blank samples, so they'll be cleaned
up by the frequency method. The MID/CMB and Iberian medieval samples will have
contaminants removed based on the prevalence method.
```{r contaminants, eval = F}
contaminant_species_mid <- cont_prev_species_list_mid %>% rownames_to_column("Species") %>% select(Species)
fwrite(contaminant_species_mid, file = "./05-results.backup/contaminant_species_mid.tsv", sep="\t", quote=F)

contaminant_species_rad <- cont_prev_species_list_rad %>% rownames_to_column("Species") %>% select(Species)
fwrite(contaminant_species_rad, file = "./05-results.backup/contaminant_species_rad.tsv", sep="\t", quote=F)

contaminant_species_iber <- cont_prev_species_list_iber %>% rownames_to_column("Species") %>% select(Species)
fwrite(contaminant_species_iber, file = "./05-results.backup/contaminant_species_iber.tsv", sep="\t", quote=F)

contaminant_species_freq_kil <- cont_freq_species_list_kil %>% rownames_to_column("Species") %>% select(Species)
fwrite(contaminant_species_freq_kil, file = "./05-results.backup/contaminant_species_freq_kil.tsv", sep="\t", quote=F)

contaminant_species_mod <- cont_prev_species_list_mod %>% rownames_to_column("Species") %>% select(Species)
fwrite(contaminant_species_mod, file = "./05-results.backup/contaminant_species_mod.tsv", sep="\t", quote=F)

```

# Decontamination with Decontam Frequency Method (CMB, MID, IVE, ELR, JAE, Kilteasheen; Radcliffe has to be prevalence)

## MID, CMB
```{r decontam_frequency_mid}
# Check for contamination by fequency
contam_mid.freq.species <- isContaminant(malt_species_mid.matrix, method="frequency", 
                                 conc=metadata_mid.decontam$`DNA_molecules_per_library_x10^6`, 
                                 threshold = 0.9)

# Print the # of species identified as contaminants by frequency
table(contam_mid.freq.species$contaminant)

cont_freq_species_list_mid <- contam_mid.freq.species[which(contam_mid.freq.species$contaminant=="TRUE"), ]

# Make a histogram to look at the distribution of the p-value (probability for classifying contaminants)

ggplot(contam_mid.freq.species, aes(x=p)) +
  geom_histogram(bins=100) +
  scale_y_log10() +
  ggtitle('Frequency - Species')

```

## Iberian Medieval
```{r decontam_frequency_iber}
# Check for contamination by fequency
contam_iber.freq.species <- isContaminant(malt_species_iber.matrix, method="frequency", 
                                 conc=metadata_iber.decontam$`DNA_molecules_per_library_x10^6`, 
                                 threshold = 0.5)

# Print the # of species identified as contaminants by frequency
table(contam_iber.freq.species$contaminant)

cont_freq_species_list_iber <- contam_iber.freq.species[which(contam_iber.freq.species$contaminant=="TRUE"), ]

# Make a histogram to look at the distribution of the p-value (probability for classifying contaminants)

ggplot(contam_iber.freq.species, aes(x=p)) +
  geom_histogram(bins=100) +
  scale_y_log10() +
  ggtitle('Frequency - Species')

```

## JAE/VLC modern
```{r decontam_frequency_mid}
# Check for contamination by fequency
contam_mod.freq.species <- isContaminant(malt_species_mod.matrix, method="frequency", 
                                 conc=metadata_mod.decontam$`DNA_molecules_per_library_x10^6`, 
                                 threshold = 0.95)

# Print the # of species identified as contaminants by frequency
table(contam_mod.freq.species$contaminant)

cont_freq_species_list_mod <- contam_mod.freq.species[which(contam_mod.freq.species$contaminant=="TRUE"), ]

# Make a histogram to look at the distribution of the p-value (probability for classifying contaminants)

ggplot(contam_mod.freq.species, aes(x=p)) +
  geom_histogram(bins=100) +
  scale_y_log10() +
  ggtitle('Frequency - Species')

```

## Kilteasheen
```{r decontam_frequency_kil}
# Check for contamination by frequency
contam_kil.freq.species <- isContaminant(malt_species_kil.matrix, method="frequency", 
                                 conc=metadata_kil.decontam$`DNA_molecules_per_library_x10^6`, 
                                 threshold = 0.7)

# Print the # of species identified as contaminants by frequency
# Check number of contaminants
table(contam_kil.freq.species$contaminant)

# List of contaminants
cont_freq_species_list_kil <- contam_kil.freq.species[which(contam_kil.freq.species$contaminant=="TRUE"), ]

# Make a histogram to look at the distribution of the p-value (probability for classifying contaminants)

ggplot(contam_kil.freq.species, aes(x=p)) +
  geom_histogram(bins=100) +
  scale_y_log10() +
  ggtitle('Frequency - Species')

```


```{r contaminants, eval = F}
contaminant_species_freq_mid <- cont_prev_species_list_mid %>% rownames_to_column("Species") %>% select(Species)
fwrite(contaminant_species_freq_mid, file = "./05-results.backup/contaminant_species_freq_mid.tsv", sep="\t", quote=F)

# contaminant_species_freq_rad <- cont_prev_species_list_rad %>% rownames_to_column("Species") %>% select(Species)
# fwrite(contaminant_species_freq_rad, file = "./05-results.backup/contaminant_species_freq_rad.tsv", sep="\t", quote=F)

contaminant_species_freq_iber <- cont_prev_species_list_iber %>% rownames_to_column("Species") %>% select(Species)
fwrite(contaminant_species_freq_iber, file = "./05-results.backup/contaminant_species_freq_iber.tsv", sep="\t", quote=F)

contaminant_species_freq_kil <- cont_freq_species_list_kil %>% rownames_to_column("Species") %>% select(Species)
fwrite(contaminant_species_freq_kil, file = "./05-results.backup/contaminant_species_freq_kil.tsv", sep="\t", quote=F)

contaminant_species_freq_mod <- cont_prev_species_list_mod %>% rownames_to_column("Species") %>% select(Species)
fwrite(contaminant_species_freq_mod, file = "./05-results.backup/contaminant_species_freq_mod.tsv", sep="\t", quote=F)

```


# Not Used

Check the combined prevalence and frequency method to see how it differs from the individual methods. 
```{r decontam_combined, eval=F}
# Assign sample-type status to identify control samples (same as was done for prevalence)
metadata.decontam$is.control <- metadata.decontam$Sample_or_Control=="Control"

# Assign contaminant status
contam.comb.species <- isContaminant(malt_species.matrix, method="combined", 
                                 conc=metadata.decontam$`DNA_molecules_per_library_x10^6`, 
                                 neg=metadata.decontam$is.control,
                                 threshold = 0.9)

## Check how many contaminants
table(contam.comb.species$contaminant)

## List of contaminants
cont_comb_species_list <- contam.comb.species[which(contam.comb.species$contaminant=="TRUE"), ]

# Graph it to look at the histogram and pick a suitable probability-values cut-off
ggplot(contam.comb.species, aes(x=p)) +
  geom_histogram(bins=100) +
  scale_y_log10() +
  geom_hline(yintercept=10, linetype="dashed", color = "red") +
  geom_hline(yintercept=2, linetype="dashed", color = "red") +
  ggtitle('Combined - Species')

```
















