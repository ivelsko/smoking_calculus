---
title: "MID/CMB, Radcliffe, Kilteasheen, Iberian medieval calculus MALT alpha diversity"
author: "Irina Velsko"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
    github_document:
        fig_width: 8
        fig_height: 6
        toc: true
---

```{r load_libraries, echo = F, message = F}
library(knitr)
library(data.table)
library(mixOmics)
library(rstatix)
library(vegan)
library(compositions)
library(janitor)
library(ggheatmap)
library(tidyverse)
library(gplots)
library(cowplot)
opts_chunk$set(echo=F, warning=F, message=F, dpi=150)
```

Set the working directory of the notebook to the parent directory of the 
notebook itself.  

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

```{r load_data}
# load the metadata file
load("./05-results.backup/Metadata_tables.RData")

# read in the species table
mpa3_raw <- fread("./05-results.backup/mpa3_abundance_table.tsv") %>%
  select(-NCBI_tax_id)

# clean the file names
colnames(mpa3_raw) <- gsub(".metaphlan3","", colnames(mpa3_raw))
colnames(mpa3_raw) <- gsub(".SG1","", colnames(mpa3_raw))

# filter to have only species
mpa3_sp <- mpa3_raw %>% 
  filter(str_detect(clade_name, "s__")) %>%
  separate(clade_name, into = c("K","P","C","O","F","G","Species"), sep = "\\|") %>%
  select(-c("K","P","C","O","F","G")) %>%
  mutate(Species = str_replace_all(Species, "s__",""),
         Species = str_replace_all(Species, "_"," ")) %>%
  # these samples have no metadata
  select(-c("MID025.A0101","MID033.A0101","MID052.A0101","MID056.A0101","MID065.A0101","MID068.A0101","MID076.A0101","MID078.A0101")) %>%
  arrange(Species)

```

```{r}
# load the metadata file again without factors for stats
metadata_nofactors <- fread("./00-documentation.backup/radcliffe_pfuT_metadata.tsv") %>%
  bind_rows(., fread("./00-documentation.backup/iberian_medieval_metadata.tsv")) %>%
  bind_rows(., fread("./00-documentation.backup/kilteasheen_metadata.tsv")) %>%
  bind_rows(., fread("./00-documentation.backup/mod_metadata.tsv")) %>%
  full_join(., fread("./00-documentation.backup/MID_analysis_metadata.tsv"))

```


Now decontam the tables
```{r}
mpa3_contaminants <- fread("./05-results.backup/contaminant_species_mid_mpa3.tsv", sep = "\t") %>%
  bind_rows(., fread("./05-results.backup/contaminant_species_kilteasheen_mpa3.tsv", sep = "\t")) %>%
  bind_rows(., fread("./05-results.backup/contaminant_species_iberia_mpa3.tsv", sep = "\t")) %>%
  unique()

# remove contaminant species from nt table
mpa3_species_decontam <- mpa3_sp %>%
  anti_join(., mpa3_contaminants)

```

List the outliers from the plot in `MID_CMB_Rad_Kil_Iber_decontam.Rmd`. 
```{r outliers}
outliers_mpa3 <- c("EXB059.A2101","EXB059.A2501","EXB015.A3301","EXB034.A2701","EXB059.A2201","EXB059.A2301","EXB059.A2401","LIB058.A0103","LIB058.A0106","LIB058.A0104")
poor_samples_mpa3 <- fread("./05-results.backup/cuperdec_mpa3_poor_samples.tsv") %>%
  pull(Sample)

outliersF <- str_c(outliers_mpa3, collapse = "|")

```

```{r rem_poor_renorm}
mpa3_species_decontam <- mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3))%>%
  adorn_percentages(denominator = "col") %>%
  pivot_longer(!Species, names_to = "Library_ID", values_to = "Percent") %>%
  mutate(Percent = Percent * 100) %>%
  pivot_wider(names_from = "Library_ID", values_from = "Percent")

```


```{r box_plotting_functions}

plot_box_whisker <- function(df, stat_info, metadata_group, fill_group) {
    fill_group_colors <- get(paste(fill_group, "_colors", sep = ""))

      df_X <- df %>%
              inner_join(full_metadata %>%
                           select(Library_ID, Site_code, Region, Time_period, Sample_or_Control, Periodontal_disease_present, Caries_present, Sex, Age), by = "Library_ID")

    stat_info_table = df_X[[stat_info]]
    metadata_group = df_X[[metadata_group]]
    fill_group = df_X[[fill_group]]

    bx_wh_plot <- ggplot(df_X, aes(x = metadata_group, y = stat_info_table, fill = fill_group)) +
                         geom_boxplot(color = "grey30") +
                         scale_fill_manual(values = fill_group_colors) +
                         theme_minimal(base_size = 18) +
                         #scale_y_continuous(trans='log10') +
                         #scale_y_continuous(trans='pseudo_log') +
                         theme(axis.text.x = element_text(angle = 45, hjust = 1),
                               text = element_text(size=20)) +
                         ylab(stat_info) +
                         xlab(metadata_group)

    return(bx_wh_plot)
}

```

```{r box_plotting_functions_mid, eval = F}

plot_box_whisker_mid <- function(df, stat_info, metadata_group, fill_group) {
    fill_group_colors <- get(paste(fill_group, "_colors", sep = ""))

      df_X <- df %>%
              inner_join(full_metadata %>%
                           filter(str_detect(Library_ID, "MID")), by = "Library_ID")

    stat_info_table = df_X[[stat_info]]
    metadata_group = df_X[[metadata_group]]
    fill_group = df_X[[fill_group]]

    bx_wh_plot <- ggplot(df_X, aes(x = metadata_group, y = stat_info_table, fill = fill_group)) +
                         geom_boxplot(color = "grey30") +
                         scale_fill_manual(values = fill_group_colors) +
                         theme_minimal(base_size = 18) +
                         #scale_y_continuous(trans='log10') +
                         #scale_y_continuous(trans='pseudo_log') +
                         theme(axis.text.x = element_text(angle = 45, hjust = 1),
                               text = element_text(size=20)) +
                         ylab(stat_info) +
                         xlab(metadata_group)

    return(bx_wh_plot)
}

```


# Alpha-diversity of all samples
First we want to know if there are differences in the total diveristy of
identified species between various metadata categories. We'll look at
alpha-diversity for this, using both the observed species and Shannon diverity
metrics. Observed species to tell us which metadata categories have more
species/genera, and Shannon to tell us which has more even distribution of
species/genera.

## Observed Speceies
```{r observed_species}
# make Relab binary to make a presence/absence table
presabs_table <- mpa3_species_decontam %>%
  select(-matches("EXB|LIB|CSN|CSL|CSS|CSD")) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>%
  gather("Species","Counts",2:ncol(.)) %>%
  mutate(Counts = ifelse(Counts > 0, 1, 0)) %>%
  spread(Species, Counts) %>%
  column_to_rownames("Library_ID")

# calculate observed species for each sample with janitor 'adorn_totals'
mpa3_species_decontam.os <- presabs_table %>%
  adorn_totals(., where = "col", name = "Observed_species") %>%
  select(Observed_species) %>%
  rownames_to_column("Library_ID") %>%
  filter(!str_detect(Library_ID, "EXB|LIB")) 

plot_box_whisker(mpa3_species_decontam.os, "Observed_species", "Site_code", "Site_code")
plot_box_whisker(mpa3_species_decontam.os, "Observed_species", "Region", "Region")

# os_plot <-mpa3_species_decontam.os %>%
#   inner_join(full_metadata %>%
#                select(Library_ID, Site_code, Region, Time_period, Sample_or_Control, 
#                       Periodontal_disease_present, Caries_present, Sex, Age), by = "Library_ID") %>%
# # remove blanks
# filter(!str_detect(Library_ID, "EXB|LIB")) %>%
#   ggplot(., aes(x = Site_code, y = Observed_species, fill = Site_code)) +
#                          geom_boxplot() +
#                          scale_fill_manual(values = Site_code_colors) +
#                          theme_minimal(base_size = 18) +
#                          #scale_y_continuous(trans='log10') +
#                          #scale_y_continuous(trans='pseudo_log') +
#                          theme(axis.text.x = element_text(angle = 45, hjust = 1),
#                               text = element_text(size=18)) +
#                          ylab("Number of Species") +
#                          xlab("")
# os_plot

os_plot <- mpa3_species_decontam.os %>%
  inner_join(., full_metadata, by = "Library_ID") %>%
  # filter(!str_detect(Library_ID, "JAE|CMB")) %>%
  ggplot(., aes(x = Site_code, y = Observed_species, fill = Site_code)) +
  geom_boxplot(color = "grey30") +
  geom_point(alpha = 0.5, color = "grey30", position = position_jitterdodge()) +
  scale_fill_manual(values = Site_code_colors) +
  theme_minimal(base_size = 18) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        text = element_text(size=20)) +
  ylab("Observed species") +
  xlab("Site")
os_plot


# ggsave("~/Desktop/MID_os_plot_site.pdf", plot = os_plot, device = "pdf",
#        scale = 1, width = 9, height = 5, units = c("in"), dpi = 300)

# now on filtered tables
presabs_table_f <- mpa3_species_decontam %>%
  select(-matches("EXB|LIB|CSN|CSL|CSD|CSS")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  filter(Percent > 0.001) %>%
  select(-one_of(c("Sum_species.decontam","Percent"))) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>%
  gather("Species","Counts",2:ncol(.)) %>%
  mutate(Counts = ifelse(Counts > 0, 1, 0)) %>%
  spread(Species, Counts) %>%
  column_to_rownames("Library_ID")
  
# calculate observed species for each sample with janitor 'adorn_totals'
mpa3_species_decontam_filtered.os <- presabs_table_f %>%
  adorn_totals(., where = "col", name = "Observed_species") %>%
  select(Observed_species) %>%
  rownames_to_column("Library_ID")  

plot_box_whisker(mpa3_species_decontam_filtered.os, "Observed_species", "Site_code", "Site_code")
plot_box_whisker(mpa3_species_decontam_filtered.os, "Observed_species", "Time_period", "Region")
plot_box_whisker(mpa3_species_decontam_filtered.os, "Observed_species", "Region", "Time_period")
plot_box_whisker(mpa3_species_decontam_filtered.os, "Observed_species", "Time_period", "Time_period")


filtered_os <- mpa3_species_decontam_filtered.os %>%
  inner_join(., full_metadata, by = "Library_ID") %>%
  ggplot(., aes(x = Site_code, y = Observed_species, fill = Site_code)) +
  geom_boxplot(color = "grey30") +
  geom_point(alpha = 0.5, color = "grey30", position = position_jitterdodge(jitter.width = 2)) +
  scale_fill_manual(values = Site_code_colors) +
  theme_minimal(base_size = 18) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        text = element_text(size=20)) +
  ylab("Observed species") +
  xlab("Site_code") +
  ggtitle("Filtered") +
  theme(plot.title=element_text(size=10))
filtered_os

# ggsave("~/Desktop/MID_os_filtered_plot_site.pdf", plot = filtered_os, device = "pdf",
#        scale = 1, width = 8, height = 5, units = c("in"), dpi = 300)

plot1 <-  mpa3_species_decontam_filtered.os %>%
  inner_join(., full_metadata, by = "Library_ID") %>%
  ggplot(., aes(x = Time_period, y = Observed_species, fill = Time_period)) +
  geom_boxplot(color = "grey30") +
  geom_point(alpha = 0.5, color = "grey30", position = position_jitterdodge(jitter.width = 2)) +
  scale_fill_manual(values = Time_period_colors) +
  theme_minimal(base_size = 18) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        text = element_text(size=20)) +
  ylab("Observed species") +
  xlab("Site_code") +
  ggtitle("Filtered") +
  theme(plot.title=element_text(size=10))
plot1
# ggsave("~/Desktop/shannon_calculus_time_periods.pdf", plot = plot1, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)


```

```{r}
mpa3_species_decontam %>% 
  pivot_longer(!Species, names_to = "Library_ID", values_to = "Counts") %>% 
  pivot_wider(names_from = "Species", values_from = "Counts") %>% 
  select(Library_ID) %>%
  left_join(., full_metadata %>% select(Library_ID, Site_code), by = "Library_ID") %>%
  filter(!str_detect(Site_code, "EXB|LIB|DEN|SOL")) %>%
  group_by(Site_code) %>%
  count()
  
  
```



```{r species_tails}

mpa3_species_decontam %>%
  adorn_totals(where = "row") %>%
  filter(Species == "Total")


jae_mpa3 <- mpa3_raw %>%
  select(matches("clade_name|JAE"))
  
  
mpa3_species_decontam %>%
  adorn_percentages(denominator = "col") %>%
  pivot_longer(!Species, names_to = "Library_ID", values_to = "Percent") %>%
  mutate(Percent = Percent * 100) %>%
  pivot_wider(names_from = "Library_ID", values_from = "Percent") %>%
  adorn_totals(where = "row") %>%
  filter(Species == "Total")

```


## Shannon Index
```{r shannon_diversity}
# Shannon diversity with the package vegan
mpa3_species_decontam.matrix <- as.matrix(mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(-matches("EXB|LIB|CSN|CSL|CSD|CSS")) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>% 
  column_to_rownames("Library_ID"))
 
mpa3_species_decontam.shannon <- as.data.frame(diversity(mpa3_species_decontam.matrix, index = "shannon"))
names(mpa3_species_decontam.shannon)[1] <- "Shannon_index"

# merge with the metadata file and plot
mpa3_species_decontam.shannon <- mpa3_species_decontam.shannon %>%
  rownames_to_column("Library_ID")

plot_box_whisker(mpa3_species_decontam.shannon, "Shannon_index", "Site_code", "Site_code")
plot_box_whisker(mpa3_species_decontam.shannon, "Shannon_index", "Region", "Region")

shannon_sp_plot <-mpa3_species_decontam.shannon %>%
  inner_join(full_metadata %>%
               select(Library_ID, Site_code, Region, Time_period, Sample_or_Control, 
                      Periodontal_disease_present, Caries_present, Sex, Age), by = "Library_ID") %>%
  ggplot(., aes(x = Site_code, y = Shannon_index, fill = Site_code)) +
                         geom_boxplot() +
                         scale_fill_manual(values = Site_code_colors) +
                         theme_minimal(base_size = 18) +
                         #scale_y_continuous(trans='log10') +
                         #scale_y_continuous(trans='pseudo_log') +
                         theme(axis.text.x = element_text(angle = 45, hjust = 1),
                              text = element_text(size=18)) +
                         ylab("Shannon index") +
                         xlab("")
shannon_sp_plot

# now with the filtered data
mpa3_species_decontam_filtered.matrix <- as.matrix(mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(-matches("EXB|LIB|CSN|CSL|CSD|CSS")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  filter(Percent > 0.001) %>%
  select(-one_of(c("Sum_species.decontam","Percent"))) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>% 
  column_to_rownames("Library_ID"))

mpa3_species_decontam_filtered.shannon <- as.data.frame(diversity(mpa3_species_decontam_filtered.matrix, index = "shannon"))
names(mpa3_species_decontam_filtered.shannon)[1] <- "Shannon_index"

# merge with the metadata file and plot
mpa3_species_decontam_filtered.shannon <- mpa3_species_decontam_filtered.shannon %>%
  rownames_to_column("Library_ID")

plot_box_whisker(mpa3_species_decontam_filtered.shannon, "Shannon_index", "Site_code", "Site_code")
plot_box_whisker(mpa3_species_decontam_filtered.shannon, "Shannon_index", "Time_period", "Region")
plot_box_whisker(mpa3_species_decontam_filtered.shannon, "Shannon_index", "Region", "Time_period")
plot_box_whisker(mpa3_species_decontam_filtered.shannon, "Shannon_index", "Time_period", "Time_period")

plot1 <-  mpa3_species_decontam_filtered.shannon %>%
  inner_join(., full_metadata, by = "Library_ID") %>%
  ggplot(., aes(x = Time_period, y = Shannon_index, fill = Time_period)) +
  geom_boxplot(color = "grey30") +
  geom_point(alpha = 0.5, color = "grey30", position = position_jitterdodge(jitter.width = 2)) +
  scale_fill_manual(values = Time_period_colors) +
  theme_minimal(base_size = 18) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        text = element_text(size=20)) +
  ylab("Shannon index") +
  xlab("Site_code") +
  ggtitle("Filtered") +
  theme(plot.title=element_text(size=10))
plot1
# ggsave("~/Desktop/shannon_calculus_time_periods.pdf", plot = plot1, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)


```

```{r shannon_histogram, eval = F}

plot1 <- mpa3_species_decontam_filtered.shannon %>%
  # mutate(Shannon_index = )
  inner_join(full_metadata %>%
               select(Library_ID, Site_code, Region, Time_period, Sample_or_Control, 
                      Periodontal_disease_present, Caries_present, Sex, Age), by = "Library_ID") %>%
  ggplot(., aes(x = Shannon_index, color = Time_period)) +
  geom_density() +
  theme_minimal(base_size = 18) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1),
        text = element_text(size=20)) +
  ylab("") +
  xlab("Shannon index")
plot1

# ggsave("~/Desktop/shannon_calculus_time_periods.pdf", plot = plot1, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

```


## Pielou's Evenness
Let's also look specifically at evenness of the samples using Pielou's evenness.
This calculation (derived from Shannon's index) gives us a number from 0 to 1,
where 0 is no evenness and 1 is perfect evenness. We want to see if there are
any groups that have substantially greater species/genera evenness than the
others. We're not interested in what the actual number is, or how even the
samples appear to be, except relative to eachother.
```{r evenness_pielou}
evenness.species <- diversity(mpa3_species_decontam.matrix)
evenness.species <- as.data.frame(evenness.species/log(specnumber(mpa3_species_decontam.matrix)))
names(evenness.species)[1] <- "Pileou_evenness"

# merge with the metadata file and plot
evenness.species <- evenness.species %>%
  rownames_to_column("Library_ID")

plot_box_whisker(evenness.species, "Pileou_evenness", "Site_code", "Site_code")
plot_box_whisker(evenness.species, "Pileou_evenness", "Time_period", "Region")

pe_sp_plot <-evenness.species %>%
  inner_join(full_metadata %>%
               select(Library_ID, Site_code, Region, Time_period, Sample_or_Control, 
                      Periodontal_disease_present, Caries_present, Sex, Age), by = "Library_ID") %>%
  ggplot(., aes(x = Site_code, y = Pileou_evenness, fill = Site_code)) +
                         geom_boxplot() +
                         scale_fill_manual(values = Site_code_colors) +
                         theme_minimal(base_size = 18) +
                         #scale_y_continuous(trans='log10') +
                         #scale_y_continuous(trans='pseudo_log') +
                         theme(axis.text.x = element_text(angle = 45, hjust = 1),
                              text = element_text(size=18)) +
                         ylab("Pielou's evenness") +
                         xlab("")
pe_sp_plot

# now with filtered data
evenness.species_filtered <- diversity(mpa3_species_decontam_filtered.matrix)
evenness.species_filtered <- as.data.frame(evenness.species_filtered/log(specnumber(mpa3_species_decontam_filtered.matrix)))
names(evenness.species_filtered)[1] <- "Pileou_evenness"

# merge with the metadata file and plot
evenness.species_filtered <- evenness.species_filtered %>%
  rownames_to_column("Library_ID")

plot_box_whisker(evenness.species_filtered, "Pileou_evenness", "Site_code", "Site_code")
plot_box_whisker(evenness.species_filtered, "Pileou_evenness", "Time_period", "Region")
plot_box_whisker(evenness.species_filtered, "Pileou_evenness", "Region", "Time_period")
plot_box_whisker(evenness.species_filtered, "Pileou_evenness", "Time_period", "Time_period")

```


## Stats for samples without controls
```{r tables_for_stats}
# Filtered species tables alpha-diversity stats
# get the number of observed species
presabs_table_f <- mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(-matches("EXB|LIB|CSN|CSL|CSD|CSS")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  filter(Percent > 0.001) %>%
  select(-one_of(c("Sum_species.decontam","Percent"))) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>%
  gather("Species","Counts",2:ncol(.)) %>%
  mutate(Counts = ifelse(Counts > 0, 1, 0)) %>%
  spread(Species, Counts) %>%
  column_to_rownames("Library_ID")
  
# calculate observed species for each sample with janitor 'adorn_totals'
mpa3_species_decontam_filtered.alpha <- presabs_table_f %>%
  adorn_totals(., where = "col", name = "Observed_species") %>%
  select(Observed_species) %>%
  rownames_to_column("Library_ID") 


# get the Shannon index
mpa3_species_decontam_filtered.matrix <- as.matrix(mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(-matches("EXB|LIB|CSN|CSL|CSD|CSS")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  filter(Percent > 0.001) %>%
  select(-one_of(c("Sum_species.decontam","Percent"))) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>% 
  column_to_rownames("Library_ID"))

mpa3_species_decontam_filtered.shannon <- as.data.frame(diversity(mpa3_species_decontam_filtered.matrix, index = "shannon"))
names(mpa3_species_decontam_filtered.shannon)[1] <- "Shannon_index"

# convert row names to a column and combine with the observed species table
mpa3_species_decontam_filtered.alpha <- mpa3_species_decontam_filtered.alpha %>%
  full_join(., mpa3_species_decontam_filtered.shannon %>%
  rownames_to_column("Library_ID"), by = "Library_ID")
  
# Get the evenness index
evenness.species_filtered <- diversity(mpa3_species_decontam_filtered.matrix)
evenness.species_filtered <- as.data.frame(evenness.species_filtered/log(specnumber(mpa3_species_decontam_filtered.matrix)))
names(evenness.species_filtered)[1] <- "Pileou_evenness"

# merge with the metadata file and plot
mpa3_species_decontam_filtered.alpha <- mpa3_species_decontam_filtered.alpha %>%
  full_join(., evenness.species_filtered %>%
  rownames_to_column("Library_ID"), by = "Library_ID")

# now plot the observed species
os_site <- plot_box_whisker(mpa3_species_decontam_filtered.alpha, "Observed_species", "Site_code", "Site_code")
os_site
shannon_site <- plot_box_whisker(mpa3_species_decontam_filtered.alpha, "Shannon_index", "Site_code", "Site_code")
shannon_site
pe_site <- plot_box_whisker(mpa3_species_decontam_filtered.alpha, "Pileou_evenness", "Site_code", "Site_code")
pe_site

# ggsave("./06-publication/supplemental_figures/SXX6/panel_parts/Figure_SXX6_os_market_split.pdf", plot = os_market_split, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

# add metadata to the table
mpa3_species_decontam_filtered.alpha_meta <- mpa3_species_decontam_filtered.alpha %>%
  full_join(., metadata_nofactors %>%
               select(Library_ID, Site_code, Region, Time_period, Sample_or_Control, 
                      Periodontal_disease_present, Caries_present, Sex, Age), by = "Library_ID") %>%
  drop_na(Observed_species) %>%
  filter(!str_detect(Library_ID, "ARS"))

fwrite(mpa3_species_decontam_filtered.alpha, "~/archgen/microbiome_calculus/smoking_calculus/05-results.backup/mpa3_alpha_div_numbers.tsv", sep = "\t", quote = F)

```


```{r kruskal_test}
# define the metadata categories to test for significnat differences in diversity
Envmt <- colnames(mpa3_species_decontam_filtered.alpha_meta %>%
                    select(Site_code, Time_period))

# test for significant differences in diversity between the metadata categories
species_kruskal_pvals <- lapply(Envmt, function(envmt) {
pvalues_envmt <- mpa3_species_decontam_filtered.alpha_meta %>%
  select(Library_ID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  kruskal_test(Observed_species ~ lastone) %>% # number of species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta %>% 
              select(Library_ID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Shannon_index ~ lastone) %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta %>% 
              select(Library_ID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Pileou_evenness ~ lastone) %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble() %>%
  arrange(p)
species_kruskal_pvals

# fwrite(species_kruskal_pvals, "./06-publication/supplemental_tables/alphadiv_kruskal_wallace_mpa3_sp.tsv", sep = "\t", quote = F)

```

```{r wilcox_test}
# pull out only the metadata categories that were significantly different between groups from the Kruskal-Wallace test
Envmt_sig <- species_kruskal_pvals %>%
  filter(p <= 0.05) %>%
  distinct(Category) %>%
  pull(Category)

# run a post-hoc test on those metadata categories to see which groups in them are significantly different
species_wilcox_pvals <- lapply(Envmt_sig, function(envmt) {
pvalues_envmt <- mpa3_species_decontam_filtered.alpha_meta %>%
  select(Library_ID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  pairwise_wilcox_test(Observed_species ~ lastone, p.adjust.method = "fdr") %>% # number of species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta %>% 
              select(Library_ID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            pairwise_wilcox_test(Shannon_index ~ lastone, p.adjust.method = "fdr") %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta %>% 
              select(Library_ID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            pairwise_wilcox_test(Pileou_evenness ~ lastone, p.adjust.method = "fdr") %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble( )%>%
  # filter(p.adj <= 0.05) %>%
  rename(Index = .y.) %>%
  select(Index, Category, everything()) %>%
  arrange(p.adj)

species_wilcox_pvals


```

```{r wilcox_eff_size}
# and check the effect size
species_wilcox_effs <- lapply(Envmt_sig, function(envmt) {
pvalues_envmt <- mpa3_species_decontam_filtered.alpha_meta %>%
  select(Library_ID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  wilcox_effsize(Observed_species ~ lastone) %>% # number of species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta %>% 
              select(Library_ID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            wilcox_effsize(Shannon_index ~ lastone) %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta %>% 
              select(Library_ID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            wilcox_effsize(Pileou_evenness ~ lastone) %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble( ) %>%
  select(.y.,Category, everything()) %>%
  arrange(desc(effsize)) %>%
  rename(Index = .y.)


IC_species_p_es <- species_wilcox_pvals %>%
  full_join(., species_wilcox_effs, by = c("Index","Category","group1","group2","n1","n2")) %>%
  select(Index, Category, everything()) %>%
  arrange(p.adj)
  
IC_species_p_es %>%
  arrange(Index, Category, p.adj)

# fwrite(IC_species_p_es, "./06-publication/supplemental_tables/alphadiv_wilcox_mpa3_sp.tsv", sep = "\t", quote = F)
# fwrite(IC_species_p_es, "~/Desktop/mid_alpha_stats.tsv", sep = "\t", quote = F)

```

```{r raincloud_plots_os_tp}
mpa3_species_decontam_filtered.alpha_meta %>%
ggplot(., aes(x = Time_period, y = Observed_species, fill = Time_period)) + 
  ## add half-violin from {ggdist} package
  ggdist::stat_halfeye(
    ## custom bandwidth
    adjust = .5, 
    ## adjust height
    width = .6, 
    ## move geom to the right
    justification = -.2, 
    ## remove slab interval
    .width = 0, 
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .12, 
    ## remove outliers
    outlier.color = NA, ## `outlier.shape = NA` works as well
    color = "grey30"
  ) +
  ## add dot plots from {ggdist} package
  ggdist::stat_dots(
    ## orientation to the left
    side = "left", 
    ## move geom to the left
    justification = 1.1, 
    ## adjust grouping (binning) of observations 
    binwidth = 1
  ) + 
  ## remove white space on the left
  coord_cartesian(xlim = c(1.2, NA)) +
  theme_minimal() +
  scale_fill_manual(values = Time_period_colors)


```

```{r raincloud_plots_os_site}
mpa3_species_decontam_filtered.alpha_meta %>%
  mutate(Site_code = fct_relevel(Site_code, "MID","CMB","RAD","KIL","ELR","IVE","JAE","VLC")) %>%
ggplot(., aes(x = Site_code, y = Observed_species, fill = Site_code)) + 
  ## add half-violin from {ggdist} package
  ggdist::stat_halfeye(
    ## custom bandwidth
    adjust = .5, 
    ## adjust height
    width = .6, 
    ## move geom to the right
    justification = -.2, 
    ## remove slab interval
    .width = 0, 
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .12, 
    ## remove outliers
    outlier.color = NA, ## `outlier.shape = NA` works as well
    color = "grey30"
  ) +
  ## add dot plots from {ggdist} package
  ggdist::stat_dots(
    ## orientation to the left
    side = "left", 
    ## move geom to the left
    justification = 1.1, 
    ## adjust grouping (binning) of observations 
    binwidth = 1
  ) + 
  ## remove white space on the left
  coord_cartesian(xlim = c(1.2, NA)) +
  theme_minimal() +
  scale_fill_manual(values = Site_code_colors)


```

```{r raincloud_plots_sh}

ggplot(mpa3_species_decontam_filtered.alpha_meta, aes(x = Time_period, y = Shannon_index, fill = Time_period)) + 
  ## add half-violin from {ggdist} package
  ggdist::stat_halfeye(
    ## custom bandwidth
    adjust = .5, 
    ## adjust height
    width = .6, 
    ## move geom to the right
    justification = -.2, 
    ## remove slab interval
    .width = 0, 
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .12, 
    ## remove outliers
    outlier.color = NA, ## `outlier.shape = NA` works as well
    color = "grey30"
  ) +
  ## add dot plots from {ggdist} package
  ggdist::stat_dots(
    ## orientation to the left
    side = "left", 
    ## move geom to the left
    justification = 1.1, 
    ## adjust grouping (binning) of observations 
    binwidth = .03
  ) + 
  ## remove white space on the left
  coord_cartesian(xlim = c(1.2, NA)) +
  theme_minimal() +
  scale_fill_manual(values = Time_period_colors)


```

```{r raincloud_plots_sh_site}
mpa3_species_decontam_filtered.alpha_meta %>%
  mutate(Site_code = fct_relevel(Site_code, "MID","CMB","RAD","KIL","ELR","IVE","JAE","VLC")) %>%
ggplot(., aes(x = Site_code, y = Shannon_index, fill = Site_code)) + 
  ## add half-violin from {ggdist} package
  ggdist::stat_halfeye(
    ## custom bandwidth
    adjust = .5, 
    ## adjust height
    width = .6, 
    ## move geom to the right
    justification = -.2, 
    ## remove slab interval
    .width = 0, 
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .12, 
    ## remove outliers
    outlier.color = NA, ## `outlier.shape = NA` works as well
    color = "grey30"
  ) +
  ## add dot plots from {ggdist} package
  ggdist::stat_dots(
    ## orientation to the left
    side = "left", 
    ## move geom to the left
    justification = 1.1, 
    ## adjust grouping (binning) of observations 
    binwidth = .03
  ) + 
  ## remove white space on the left
  coord_cartesian(xlim = c(1.2, NA)) +
  theme_minimal() +
  scale_fill_manual(values = Site_code_colors)


```

## Diversity of Industrial samples only
Let's also look at the MID samples alone and the Radcliffe samples alone. These
are the 2 groups we have the most metadata for. Are there differences in
diversity between the various metadata groups?

### Stats for MID samples only
```{r tables_for_stats_mid}
# Filtered species tables alpha-diversity stats
# get the number of observed species
presabs_table_f <- mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(matches("Species|MID")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  filter(Percent > 0.001) %>%
  select(-one_of(c("Sum_species.decontam","Percent"))) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>%
  gather("Species","Counts",2:ncol(.)) %>%
  mutate(Counts = ifelse(Counts > 0, 1, 0)) %>%
  spread(Species, Counts) %>%
  column_to_rownames("Library_ID")
  
# calculate observed species for each sample with janitor 'adorn_totals'
mpa3_species_decontam_filtered.alpha <- presabs_table_f %>%
  adorn_totals(., where = "col", name = "Observed_species") %>%
  select(Observed_species) %>%
  rownames_to_column("Library_ID") 


# get the Shannon index
mpa3_species_decontam_filtered.matrix <- as.matrix(mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(matches("Species|MID")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  filter(Percent > 0.001) %>%
  select(-one_of(c("Sum_species.decontam","Percent"))) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>% 
  column_to_rownames("Library_ID"))

mpa3_species_decontam_filtered.shannon <- as.data.frame(diversity(mpa3_species_decontam_filtered.matrix, index = "shannon"))
names(mpa3_species_decontam_filtered.shannon)[1] <- "Shannon_index"

# convert row names to a column and combine with the observed species table
mpa3_species_decontam_filtered.alpha <- mpa3_species_decontam_filtered.alpha %>%
  full_join(., mpa3_species_decontam_filtered.shannon %>%
  rownames_to_column("Library_ID"), by = "Library_ID")
  
# Get the evenness index
evenness.species_filtered <- diversity(mpa3_species_decontam_filtered.matrix)
evenness.species_filtered <- as.data.frame(evenness.species_filtered/log(specnumber(mpa3_species_decontam_filtered.matrix)))
names(evenness.species_filtered)[1] <- "Pileou_evenness"

# merge with the metadata file and plot
mpa3_species_decontam_filtered.alpha <- mpa3_species_decontam_filtered.alpha %>%
  full_join(., evenness.species_filtered %>%
  rownames_to_column("Library_ID"), by = "Library_ID") %>%
  inner_join(., full_metadata)

# now plot the observed species
# plot_box_whisker_mid(mpa3_species_decontam_filtered.alpha, "Observed_species", "Pipenotch", "Pipenotch")
# mpa3_species_decontam_filtered.alpha %>%
#   inner_join(., metadata_nofactors) %>%
#   ggplot(., aes(x = Pipenotch, y = Observed_species, fill = Pipenotch)) +
#        geom_boxplot(color = "grey30") +
#        scale_fill_manual(values = c("#311068","#C83E73")) +
#        theme_minimal(base_size = 18) +
#        #scale_y_continuous(trans='log10') +
#        #scale_y_continuous(trans='pseudo_log') +
#        theme(axis.text.x = element_text(angle = 45, hjust = 1),
#              text = element_text(size=20)) +
#        ylab("Observed_species") +
#        xlab("Pipenotch")
# 

os_pipenotch <- ggplot(mpa3_species_decontam_filtered.alpha, aes(x = Pipenotch, y = Observed_species, fill = Pipenotch)) +
  geom_boxplot(color = "grey30") +
  geom_point(alpha = 0.5, color = "grey30", position = position_jitterdodge()) +
  scale_fill_manual(values = c("#311068","#C83E73")) +
  theme_minimal(base_size = 18) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        text = element_text(size=20)) +
  ylab("Observed species") +
  xlab("Pipe notch(es)")
os_pipenotch


# ggsave("~/Desktop/MID_os_pipenotch.pdf", plot = os_pipenotch, device = "pdf",
#        scale = 1, width = 6, height = 5, units = c("in"), dpi = 300)


# add metadata to the table
mpa3_species_decontam_filtered.alpha_meta_mid <- mpa3_species_decontam_filtered.alpha %>%
  inner_join(., metadata_nofactors)

```

```{r kruskal_test_mid}
# define the metadata categories to test for significnat differences in diversity
Envmt <- colnames(mpa3_species_decontam_filtered.alpha_meta_mid %>%
                    select(Sex, Age, Pipenotch, Periodontal_disease_present, Caries_present, AMTL, Periapical_lesions, 
                           Gross_caries,`%AMTL`,`%teeth_with_caries`,`%_positions_with_Periodontal`,calc_sup_SI_score, 
                           Calc_sub_SI_score, Max_Perio_Score, Peridontal_affect_score))

# test for significant differences in diversity between the metadata categories
species_kruskal_pvals <- lapply(Envmt, function(envmt) {
pvalues_envmt <- mpa3_species_decontam_filtered.alpha_meta_mid %>%
  select(Library_ID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  kruskal_test(Observed_species ~ lastone) %>% # number of species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta_mid %>% 
              select(Library_ID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Shannon_index ~ lastone) %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta_mid %>% 
              select(Library_ID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Pileou_evenness ~ lastone) %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble() %>%
  arrange(p)
species_kruskal_pvals

# fwrite(species_kruskal_pvals, "./06-publication/supplemental_tables/alphadiv_kruskal_wallace_cmc_sp.tsv", sep = "\t", quote = F)

```

```{r wilcox_test_mid}
# pull out only the metadata categories that were significantly different between groups from the Kruskal-Wallace test
Envmt_sig <- species_kruskal_pvals %>%
  filter(p <= 0.1) %>%
  distinct(Category) %>%
  pull(Category)

# run a post-hoc test on those metadata categories to see which groups in them are significantly different
species_wilcox_pvals <- lapply(Envmt_sig, function(envmt) {
pvalues_envmt <- mpa3_species_decontam_filtered.alpha_meta_mid %>%
  select(Library_ID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  pairwise_wilcox_test(Observed_species ~ lastone, p.adjust.method = "fdr") %>% # number of species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta_mid %>% 
              select(Library_ID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            pairwise_wilcox_test(Shannon_index ~ lastone, p.adjust.method = "fdr") %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta_mid %>% 
              select(Library_ID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            pairwise_wilcox_test(Pileou_evenness ~ lastone, p.adjust.method = "fdr") %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble( ) %>%
  rename(Index = .y.)

```

```{r wilcox_eff_size_mid}
# and check the effect size
species_wilcox_effs <- lapply(Envmt_sig, function(envmt) {
pvalues_envmt <- mpa3_species_decontam_filtered.alpha_meta_mid %>%
  select(Library_ID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  wilcox_effsize(Observed_species ~ lastone) %>% # number of species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta_mid %>% 
              select(Library_ID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            wilcox_effsize(Shannon_index ~ lastone) %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta_mid %>% 
              select(Library_ID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            wilcox_effsize(Pileou_evenness ~ lastone) %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble( ) %>%
  select(.y.,Category, everything()) %>%
  arrange(desc(effsize)) %>%
  rename(Index = .y.)


IC_species_cmc_p_es <- species_wilcox_pvals %>%
  full_join(., species_wilcox_effs, by = c("Index","Category","group1","group2","n1","n2")) %>%
  select(Index, Category, everything()) %>%
  arrange(p.adj)

IC_species_cmc_p_es

# fwrite(IC_species_cmc_p_es, "./06-publication/supplemental_tables/alphadiv_wilcox_cmc_sp.tsv", sep = "\t", quote = F)

```

## Stats for Radcliffe only
```{r tables_for_stats_rad}
# Filtered species tables alpha-diversity stats
# get the number of observed species
presabs_table_f <- mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(matches("Species|CS")) %>%
  select(-matches("CSS|CSD|CSN|CSL")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  filter(Percent > 0.001) %>%
  select(-one_of(c("Sum_species.decontam","Percent"))) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>%
  gather("Species","Counts",2:ncol(.)) %>%
  mutate(Counts = ifelse(Counts > 0, 1, 0)) %>%
  spread(Species, Counts) %>%
  column_to_rownames("Library_ID")
  
# calculate observed species for each sample with janitor 'adorn_totals'
mpa3_species_decontam_filtered.alpha <- presabs_table_f %>%
  adorn_totals(., where = "col", name = "Observed_species") %>%
  select(Observed_species) %>%
  rownames_to_column("Library_ID") 


# get the Shannon index
mpa3_species_decontam_filtered.matrix <- as.matrix(mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(matches("Species|CS")) %>%
  select(-matches("CSS|CSD|CSN|CSL")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  filter(Percent > 0.001) %>%
  select(-one_of(c("Sum_species.decontam","Percent"))) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>% 
  column_to_rownames("Library_ID"))

mpa3_species_decontam_filtered.shannon <- as.data.frame(diversity(mpa3_species_decontam_filtered.matrix, index = "shannon"))
names(mpa3_species_decontam_filtered.shannon)[1] <- "Shannon_index"

# convert row names to a column and combine with the observed species table
mpa3_species_decontam_filtered.alpha <- mpa3_species_decontam_filtered.alpha %>%
  full_join(., mpa3_species_decontam_filtered.shannon %>%
  rownames_to_column("Library_ID"), by = "Library_ID")
  
# Get the evenness index
evenness.species_filtered <- diversity(mpa3_species_decontam_filtered.matrix)
evenness.species_filtered <- as.data.frame(evenness.species_filtered/log(specnumber(mpa3_species_decontam_filtered.matrix)))
names(evenness.species_filtered)[1] <- "Pileou_evenness"

# merge with the metadata file and plot
mpa3_species_decontam_filtered.alpha <- mpa3_species_decontam_filtered.alpha %>%
  full_join(., evenness.species_filtered %>%
  rownames_to_column("Library_ID"), by = "Library_ID")

# now plot the observed species
# plot_box_whisker_mid(mpa3_species_decontam_filtered.alpha, "Observed_species", "Pipenotch", "Pipenotch")
mpa3_species_decontam_filtered.alpha %>%
  inner_join(., metadata_nofactors) %>%
  ggplot(., aes(x = Periodontal_disease_present, y = Observed_species, fill = Periodontal_disease_present)) +
       geom_boxplot(color = "grey30") +
       scale_fill_manual(values = c("#311068","#C83E73")) +
       theme_minimal(base_size = 18) +
       theme(axis.text.x = element_text(hjust = 0.5),
             text = element_text(size=20)) +
       ylab("Observed_species") +
       xlab("Periodontal disease")


# ggsave("./06-publication/supplemental_figures/SXX43/panel_parts/Figure_SXX43_pe_sex_cmc_sp.pdf", plot = evenness_sex, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

# add metadata to the table
mpa3_species_decontam_filtered.alpha_meta_rad <- mpa3_species_decontam_filtered.alpha %>%
  inner_join(., metadata_nofactors, by = "Library_ID")

```

```{r kruskal_test_rad}
# define the metadata categories to test for significnat differences in diversity
Envmt <- colnames(mpa3_species_decontam_filtered.alpha_meta_rad %>%
                    select(Sex, Age, Periodontal_disease_present, Caries_present))

# test for significant differences in diversity between the metadata categories
species_kruskal_pvals <- lapply(Envmt, function(envmt) {
pvalues_envmt <- mpa3_species_decontam_filtered.alpha_meta_rad %>%
  select(Library_ID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  kruskal_test(Observed_species ~ lastone) %>% # number of species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta %>% 
              select(Library_ID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Shannon_index ~ lastone) %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta %>% 
              select(Library_ID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Pileou_evenness ~ lastone) %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble() %>%
  arrange(p)
species_kruskal_pvals

# fwrite(species_kruskal_pvals, "./06-publication/supplemental_tables/alphadiv_kruskal_wallace_cmc_sp.tsv", sep = "\t", quote = F)

```

```{r wilcox_test_rad}
# pull out only the metadata categories that were significantly different between groups from the Kruskal-Wallace test
Envmt_sig <- species_kruskal_pvals %>%
  filter(p <= 0.16) %>%
  distinct(Category) %>%
  pull(Category)

# run a post-hoc test on those metadata categories to see which groups in them are significantly different
species_wilcox_pvals <- lapply(Envmt_sig, function(envmt) {
pvalues_envmt <- mpa3_species_decontam_filtered.alpha_meta_rad %>%
  select(Library_ID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  pairwise_wilcox_test(Observed_species ~ lastone, p.adjust.method = "fdr") %>% # number of species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta_rad %>% 
              select(Library_ID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            pairwise_wilcox_test(Shannon_index ~ lastone, p.adjust.method = "fdr") %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta_rad %>% 
              select(Library_ID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            pairwise_wilcox_test(Pileou_evenness ~ lastone, p.adjust.method = "fdr") %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble( ) %>%
  rename(Index = .y.)

```

```{r wilcox_eff_size_rad}
# and check the effect size
species_wilcox_effs <- lapply(Envmt_sig, function(envmt) {
pvalues_envmt <- mpa3_species_decontam_filtered.alpha_meta_rad %>%
  select(Library_ID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  wilcox_effsize(Observed_species ~ lastone) %>% # number of species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta_rad %>% 
              select(Library_ID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            wilcox_effsize(Shannon_index ~ lastone) %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., mpa3_species_decontam_filtered.alpha_meta_rad %>% 
              select(Library_ID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            wilcox_effsize(Pileou_evenness ~ lastone) %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble( ) %>%
  select(.y.,Category, everything()) %>%
  arrange(desc(effsize)) %>%
  rename(Index = .y.)


IC_species_cmc_p_es <- species_wilcox_pvals %>%
  full_join(., species_wilcox_effs, by = c("Index","Category","group1","group2","n1","n2")) %>%
  select(Index, Category, everything()) %>%
  arrange(p.adj)

IC_species_cmc_p_es

# fwrite(IC_species_cmc_p_es, "./06-publication/supplemental_tables/alphadiv_wilcox_cmc_sp.tsv", sep = "\t", quote = F)

```

# Heatmaps
_*Need to adjust this to reflect new data, not CMC*_
```{r metadata_heatmaps}
# load the metadata file again without factors for stats
metadata_nofactors <- fread("./00-documentation.backup/radcliffe_pfuT_metadata.tsv") %>%
  bind_rows(., fread("./00-documentation.backup/iberian_medieval_metadata.tsv")) %>%
  bind_rows(., fread("./00-documentation.backup/kilteasheen_metadata.tsv")) %>%
  full_join(., fread("./00-documentation.backup/MID_analysis_metadata.tsv"))

# order the samples so they can be ordered this way in the heat maps

# order the CMC samples by Village
site_order <- metadata_nofactors %>%
  as_tibble() %>%
  mutate(Site = fct_relevel(Site_code, "Middenbeemster", "CMB", "Radcliffe", "Kilteasheen", "ELR", "IVE")) %>%
  select(Library_ID, Site) %>%
  arrange(Site) %>%
  pull(Library_ID)

mid_pipe_order <- metadata_nofactors %>%
  as_tibble() %>%
  mutate(Pipenotch = fct_relevel(Pipenotch, "Present", "Absent")) %>%
  select(Library_ID, Pipenotch) %>%
  arrange(Pipenotch) %>%
  pull(Library_ID)

# combine all 3 ordered vectors into a final ordered vector
# each_order <- c(cmc_order, jae_order, hmp_order)

```

```{r heatmap_colors, eval = F}

Site_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Site = c("Middenbeemster", "CMB", "Radcliffe", "Kilteasheen",
                                   "ELR", "IVE","Extraction_blank","Library_blank"))
Time_period_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Site = c("Industrial", "Medieval","Extraction_blank","Library_blank"))

```


Now make heatmaps of the top 50 most abundant species and genera (as an arbitrary cut-off)
```{r heatmaps_species_all}
# select the top 50 most abundant species for all samples
mpa3_species_decontam_top50_all <- mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(-matches("CSN|CSL|CSD|CSS|EXB|LIB")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  top_n(50, Percent) %>%
  select(-one_of("Sum_species.decontam","Percent")) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("Library_ID")

# CLR-transform the matrix for plotting the heatmap
mpa3_species_decontam_top50_mpa3_clr <- clr(mpa3_species_decontam_top50_all)
mpa3_species_decontam_top50_mpa3_clr <- as.matrix(mpa3_species_decontam_top50_mpa3_clr)

# orient the matrix with correct rows/columns to run the distance calculation for the species, not the samples (columns are Library_ID, rows are Species)
mpa3_species_decontam_top50_mpa3_clr_sp <- mpa3_species_decontam_top50_mpa3_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","Counts",2:ncol(.)) %>%
  spread(Library_ID,Counts)

#add the rownames back
rownames(mpa3_species_decontam_top50_mpa3_clr_sp) <- mpa3_species_decontam_top50_mpa3_clr_sp$Species
mpa3_species_decontam_top50_mpa3_clr_sp <- mpa3_species_decontam_top50_mpa3_clr_sp %>% select(-Species)

# perform a distance calculation for hierarchical clustering for the species ordering
mpa3_species_decontam_top50_mpa3_clr_dist <- vegdist(mpa3_species_decontam_top50_mpa3_clr_sp, method = "euclidian")
# cluster the data with hclust
mpa3_species_decontam_top50_mpa3_clr_dist_hr <- hclust(mpa3_species_decontam_top50_mpa3_clr_dist)
# mpa3_species_decontam_top50_mpa3_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_mpa3_order <- mpa3_species_decontam_top50_mpa3_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
mpa3_species_decontam_top50_mpa3_clr_order <- mpa3_species_decontam_top50_mpa3_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Library_ID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,50))) %>%
  select(Species, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_mpa3_order)) %>%
  arrange(SpOrder) %>%
  pull(Species)

# make the species a factor so they're in the correct order for the heatmap using the vector from the step above
mpa3_species_decontam_top50_mpa3_clr_long <- mpa3_species_decontam_top50_mpa3_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Library_ID,CLR) %>%
  mutate(Species = fct_relevel(Species, mpa3_species_decontam_top50_mpa3_clr_order)) %>%
  arrange(Species) %>%
  gather("Library_ID","CLR", 2:ncol(.))

# now cluster by sample
# convert the matrix to a data.frame
mpa3_species_decontam_top50_mpa3_clr_smp <- mpa3_species_decontam_top50_mpa3_clr %>%
  as.data.frame()

# perform a distance calculation for hierarchical clustering for the species ordering
mpa3_species_decontam_top50_mpa3_clr_smp_dist <- vegdist(mpa3_species_decontam_top50_mpa3_clr_smp, method = "euclidian")
# cluster the data with hclust
mpa3_species_decontam_top50_mpa3_clr_smp_dist_hr <- hclust(mpa3_species_decontam_top50_mpa3_clr_smp_dist)
# mpa3_species_decontam_top50_mpa3_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
smp_mpa3_order <- mpa3_species_decontam_top50_mpa3_clr_smp_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
mpa3_species_decontam_top50_mpa3_clr_smp_order <- mpa3_species_decontam_top50_mpa3_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Species,CLR) %>%
  mutate(SmpOrder = as.character(seq(1,186))) %>%  
  select(Library_ID, SmpOrder, everything()) %>%
  mutate(SmpOrder = fct_relevel(SmpOrder, smp_mpa3_order)) %>%
  arrange(SmpOrder) %>%
  pull(Library_ID)

# Plot the heatmap with samples ordered by the clustering from above
# make the Library_IDs a factor so they're in the correct order for the heatmap using the vector from the step above
mpa3_species_decontam_top50_mpa3_clr_long <- mpa3_species_decontam_top50_mpa3_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Library_ID,CLR) %>%
  mutate(Species = fct_relevel(Species, mpa3_species_decontam_top50_mpa3_clr_order)) %>%
  arrange(Species) %>%
  gather("Library_ID","CLR", 2:ncol(.)) %>%
  inner_join(., full_metadata %>%
               select(Library_ID, Time_period), by = "Library_ID") %>%
  inner_join(., Time_period_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Time_period = c("Industrial", "Medieval", "Modern","Extraction_blank","Library_blank", "Soil")), by = "Time_period") %>%
  mutate(Library_ID = fct_relevel(Library_ID, mpa3_species_decontam_top50_mpa3_clr_smp_order)) %>%
  arrange(Library_ID)

vector_color = mpa3_species_decontam_top50_mpa3_clr_long %>%
  select(Library_ID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_base <- ggplot(mpa3_species_decontam_top50_mpa3_clr_long, aes(Library_ID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

# Plot the heatmap with samples ordered by Village
# make the Library_IDs a factor so they're in the correct order for the heatmap using the vector from the step above
mpa3_species_decontam_top50_mpa3_clr_long <- mpa3_species_decontam_top50_mpa3_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Library_ID,CLR) %>%
  mutate(Species = fct_relevel(Species, mpa3_species_decontam_top50_mpa3_clr_order)) %>%
  arrange(Species) %>%
  gather("Library_ID","CLR", 2:ncol(.)) %>%
  inner_join(., full_metadata %>%
               select(Library_ID, Time_period), by = "Library_ID") %>%
  inner_join(., Time_period_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Time_period = c("Industrial", "Medieval", "Modern","Extraction_blank","Library_blank", "Soil")), by = "Time_period") %>%
  mutate(Library_ID = fct_relevel(Library_ID, site_order)) %>%
  arrange(Library_ID)

vector_color = mpa3_species_decontam_top50_mpa3_clr_long %>%
  select(Library_ID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_base <- ggplot(mpa3_species_decontam_top50_mpa3_clr_long, aes(Library_ID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

```

```{r heatmaps_species_mid}

# select the top 50 most abundant species for CMC samples
mpa3_species_decontam_top50_mid <- mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(matches("Species|MID")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  top_n(50, Percent) %>%
  select(-one_of("Sum_species.decontam","Percent")) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("Library_ID")

# also save the species as a vector
mpa3_species_decontam_top50_midV <- mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(matches("Species|MID")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  top_n(50, Percent) %>%
  select(-one_of("Sum_species.decontam","Percent")) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  spread(Library_ID,Counts) %>%
  select(Species) %>%
  mutate(Middenbeemster = 1)


# CLR-transform the matrix for plotting the heatmap
mpa3_species_decontam_top50_mid_clr <- clr(mpa3_species_decontam_top50_mid)
mpa3_species_decontam_top50_mid_clr <- as.matrix(mpa3_species_decontam_top50_mid_clr)
# orient the matrix with correct rows/columns to run the distance calculation for the species, not the samples (columns are Library_ID, rows are Species)
mpa3_species_decontam_top50_mid_clr_sp <- mpa3_species_decontam_top50_mid_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","Counts",2:ncol(.)) %>%
  spread(Library_ID,Counts)

#add the rownames back
rownames(mpa3_species_decontam_top50_mid_clr_sp) <- mpa3_species_decontam_top50_mid_clr_sp$Species
mpa3_species_decontam_top50_mid_clr_sp <- mpa3_species_decontam_top50_mid_clr_sp %>% select(-Species)

# perform a distance calculation for hierarchical clustering for the species ordering
mpa3_species_decontam_top50_mid_clr_dist <- vegdist(mpa3_species_decontam_top50_mid_clr_sp, method = "euclidian")
# cluster the data with hclust
mpa3_species_decontam_top50_mid_clr_dist_hr <- hclust(mpa3_species_decontam_top50_mid_clr_dist)
# mpa3_species_decontam_top50_mid_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_mid_order <- mpa3_species_decontam_top50_mid_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
mpa3_species_decontam_top50_mid_clr_order <- mpa3_species_decontam_top50_mid_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Library_ID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,50))) %>%
  select(Species, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_mid_order)) %>%
  arrange(SpOrder) %>%
  pull(Species)

# make the species a factor so they're in the correct order for the heatmap using the vector from the step above
mpa3_species_decontam_top50_mid_clr_long <- mpa3_species_decontam_top50_mid_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Library_ID,CLR) %>%
  mutate(Species = fct_relevel(Species, mpa3_species_decontam_top50_mid_clr_order)) %>%
  arrange(Species) %>%
  gather("Library_ID","CLR", 2:ncol(.))


# now cluster by sample
# convert the matrix to a data.frame
mpa3_species_decontam_top50_mid_clr_smp <- mpa3_species_decontam_top50_mid_clr %>%
  as.data.frame()

# perform a distance calculation for hierarchical clustering for the species ordering
mpa3_species_decontam_top50_mid_clr_smp_dist <- vegdist(mpa3_species_decontam_top50_mid_clr_smp, method = "euclidian")
# cluster the data with hclust
mpa3_species_decontam_top50_mid_clr_smp_dist_hr <- hclust(mpa3_species_decontam_top50_mid_clr_smp_dist)
# mpa3_species_decontam_top50_mid_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
smp_mid_order <- mpa3_species_decontam_top50_mid_clr_smp_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
mpa3_species_decontam_top50_mid_clr_smp_order <- mpa3_species_decontam_top50_mid_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Species,CLR) %>%
  mutate(SmpOrder = as.character(seq(1,65))) %>%  
  select(Library_ID, SmpOrder, everything()) %>%
  mutate(SmpOrder = fct_relevel(SmpOrder, smp_mid_order)) %>%
  arrange(SmpOrder) %>%
  pull(Library_ID)

# Plot the heatmap with samples ordered by the clustering from above

# Define pipenotch colors for plotting
Pipenotch_colors = c("#311068","#C83E73")

# make the Library_IDs a factor so they're in the correct order for the heatmap using the vector from the step above
mpa3_species_decontam_top50_mid_clr_long <- mpa3_species_decontam_top50_mid_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Library_ID,CLR) %>%
  mutate(Species = fct_relevel(Species, mpa3_species_decontam_top50_mid_clr_order)) %>%
  arrange(Species) %>%
  gather("Library_ID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata_nofactors %>%
               select(Library_ID, Pipenotch), by = "Library_ID") %>%
  inner_join(., Pipenotch_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Pipenotch = c("Present","Absent")), by = "Pipenotch") %>%
  mutate(Library_ID = fct_relevel(Library_ID, mpa3_species_decontam_top50_mid_clr_smp_order)) %>%
  arrange(Library_ID)

vector_color = mpa3_species_decontam_top50_mid_clr_long %>%
  select(Library_ID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_base <- ggplot(mpa3_species_decontam_top50_mid_clr_long, aes(Library_ID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

# Plot the heatmap with samples ordered by presence/absence of pipenotch
# make the Library_IDs a factor so they're in the correct order for the heatmap using the vector from the step above
mpa3_species_decontam_top50_mid_clr_long <- mpa3_species_decontam_top50_mid_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Library_ID,CLR) %>%
  mutate(Species = fct_relevel(Species, mpa3_species_decontam_top50_mid_clr_order)) %>%
  arrange(Species) %>%
  gather("Library_ID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata_nofactors %>%
               select(Library_ID, Pipenotch), by = "Library_ID") %>%
  inner_join(., Pipenotch_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Pipenotch = c("Present","Absent")), by = "Pipenotch") %>%
  mutate(Library_ID = fct_relevel(Library_ID, mid_pipe_order)) %>%
  arrange(Library_ID)

vector_color = mpa3_species_decontam_top50_mid_clr_long %>%
  select(Library_ID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_base <- ggplot(mpa3_species_decontam_top50_mid_clr_long, aes(Library_ID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

```

```{r heatmaps_species_each}
# the section above for CMC samples has to be run before this one. this section uses output from that one
# select the top 50 most abundant species for HMP samples
mpa3_species_decontam_top50_radV <- mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(matches("Species|CS")) %>%
  select(-matches("CSS|CSD|CSN|CSL")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  top_n(50, Percent) %>%
  select(-one_of("Sum_species.decontam","Percent")) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  spread(Library_ID,Counts) %>%
  select(Species) %>%
  mutate(Radcliffe = 1)

# select the top 50 most abundant species for JAE samples
mpa3_species_decontam_top50_kilV <- mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(matches("Species|calc")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  top_n(50, Percent) %>%
  select(-one_of("Sum_species.decontam","Percent")) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  spread(Library_ID,Counts) %>%
  select(Species) %>%
  mutate(Kilteasheen = 1)

mpa3_species_decontam_top50_iberV <- mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(matches("Species|ELR|IVE")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  top_n(50, Percent) %>%
  select(-one_of("Sum_species.decontam","Percent")) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  spread(Library_ID,Counts) %>%
  select(Species) %>%
  mutate(Iberia = 1)


# Now select only those species (top 50 of CMC, HMP, JAE) out of the table to create a new matrix
mpa3_species_decontam_top50_each_list <- mpa3_species_decontam_top50_midV %>%
  bind_rows(., mpa3_species_decontam_top50_radV) %>%
  bind_rows(., mpa3_species_decontam_top50_iberV) %>%
  bind_rows(., mpa3_species_decontam_top50_kilV) %>%
  select(Species) %>%
  unique() %>%
  pull()

mpa3_species_decontam_top50_each <- mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(-matches("CSS|CSD|CSN|CSL|EXB|LIB")) %>%
  filter(Species %in% mpa3_species_decontam_top50_each_list) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("Library_ID")

# There are 66 total species, 34 shared by all 4 groups; 4 unique to Radcliffe, and 3 each unique to Middenbeemster, Iberia, and Kilteasheen
all3 <- mpa3_species_decontam_top50_midV %>%
  full_join(., mpa3_species_decontam_top50_radV) %>%
  full_join(., mpa3_species_decontam_top50_iberV) %>%
  full_join(., mpa3_species_decontam_top50_kilV) %>%
  replace(is.na(.), 0) %>%
  adorn_totals(where = "col") %>%
  arrange(desc(Total), desc(Middenbeemster), desc(Radcliffe), desc(Iberia))


# CLR-transform the matrix for plotting the heatmap
mpa3_species_decontam_top50_each_clr <- clr(mpa3_species_decontam_top50_each)
mpa3_species_decontam_top50_each_clr <- as.matrix(mpa3_species_decontam_top50_each_clr)

# orient the matrix with correct rows/columns to run the distance calculation for the species, not the samples (columns are Library_ID, rows are Species)
mpa3_species_decontam_top50_each_clr_sp <- mpa3_species_decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","Counts",2:ncol(.)) %>%
  spread(Library_ID,Counts)

#add the rownames back
rownames(mpa3_species_decontam_top50_each_clr_sp) <- mpa3_species_decontam_top50_each_clr_sp$Species
mpa3_species_decontam_top50_each_clr_sp <- mpa3_species_decontam_top50_each_clr_sp %>% select(-Species)

# perform a distance calculation for hierarchical clustering for the species ordering
mpa3_species_decontam_top50_each_clr_dist <- vegdist(mpa3_species_decontam_top50_each_clr_sp, method = "euclidian")
# cluster the data with hclust
mpa3_species_decontam_top50_each_clr_dist_hr <- hclust(mpa3_species_decontam_top50_each_clr_dist)
# mpa3_species_decontam_top50_each_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_each_order <- mpa3_species_decontam_top50_each_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
mpa3_species_decontam_top50_each_clr_order <- mpa3_species_decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Library_ID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,66))) %>%
  select(Species, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_each_order)) %>%
  arrange(SpOrder) %>%
  pull(Species)

# make the species a factor so they're in the correct order for the heatmap using the vector from the step above
mpa3_species_decontam_top50_each_clr_long <- mpa3_species_decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Library_ID,CLR) %>%
  mutate(Species = fct_relevel(Species, mpa3_species_decontam_top50_each_clr_order)) %>%
  arrange(Species) %>%
  gather("Library_ID","CLR", 2:ncol(.))

# now cluster by sample
# convert the matrix to a data.frame
mpa3_species_decontam_top50_each_clr_smp <- mpa3_species_decontam_top50_each_clr %>%
  as.data.frame()

# perform a distance calculation for hierarchical clustering for the species ordering
mpa3_species_decontam_top50_each_clr_smp_dist <- vegdist(mpa3_species_decontam_top50_each_clr_smp, method = "euclidian")
# cluster the data with hclust
mpa3_species_decontam_top50_each_clr_smp_dist_hr <- hclust(mpa3_species_decontam_top50_each_clr_smp_dist)
# mpa3_species_decontam_top50_each_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
smp_each_order <- mpa3_species_decontam_top50_each_clr_smp_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
mpa3_species_decontam_top50_each_clr_smp_order <- mpa3_species_decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Species,CLR) %>%
  mutate(SmpOrder = as.character(seq(1,186))) %>%  
  select(Library_ID, SmpOrder, everything()) %>%
  mutate(SmpOrder = fct_relevel(SmpOrder, smp_each_order)) %>%
  arrange(SmpOrder) %>%
  pull(Library_ID)

# Plot the heatmap with samples ordered by the clustering from above
# make the Library_IDs a factor so they're in the correct order for the heatmap using the vector from the step above
mpa3_species_decontam_top50_each_clr_long <- mpa3_species_decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Library_ID,CLR) %>%
  mutate(Species = fct_relevel(Species, mpa3_species_decontam_top50_each_clr_order)) %>%
  arrange(Species) %>%
  gather("Library_ID","CLR", 2:ncol(.)) %>%
  inner_join(., full_metadata %>%
               select(Library_ID, Site_code), by = "Library_ID") %>%
  inner_join(., Site_code_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Site_code = c("MID", "CMB", "RAD", "KIL",
                                   "ELR", "IVE","JAE","VLC","EXB","LIB","DEN","SOL")), by = "Site_code") %>%
  mutate(Library_ID = fct_relevel(Library_ID, mpa3_species_decontam_top50_each_clr_smp_order)) %>%
  arrange(Library_ID)

vector_color = mpa3_species_decontam_top50_each_clr_long %>%
  select(Library_ID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_base <- ggplot(mpa3_species_decontam_top50_each_clr_long, aes(Library_ID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 11) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, vjust = 0.5, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

# ggsave("./06-publication/supplemental_figures/SXX8/Figure_SXX8_top50_sp_heatmap_clustered.pdf", plot = heatmap_base, device = "pdf",
#        scale = 1, width = 8, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./06-publication/supplemental_figures/SXX8/Figure_SXX8_top50_sp_heatmap_clustered.png", plot = heatmap_base, device = "png",
#        scale = 1, width = 8, height = 5, units = c("in"), dpi = 300)


# Plot the heatmap with samples ordered by Village
# make the Library_IDs a factor so they're in the correct order for the heatmap using the vector from the step above
mpa3_species_decontam_top50_each_clr_long <- mpa3_species_decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Library_ID,CLR) %>%
  mutate(Species = fct_relevel(Species, mpa3_species_decontam_top50_each_clr_order)) %>%
  arrange(Species) %>%
  gather("Library_ID","CLR", 2:ncol(.)) %>%
  inner_join(., full_metadata %>%
               select(Library_ID, Site_code), by = "Library_ID") %>%
  inner_join(., Site_code_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Site_code = c("MID", "CMB", "RAD", "KIL",
                                   "ELR", "IVE","JAE","VLC","EXB","LIB", "DEN","SOL")), by = "Site_code") %>%
  mutate(Library_ID = fct_relevel(Library_ID, site_order)) %>%
  arrange(Library_ID)

vector_color = mpa3_species_decontam_top50_each_clr_long %>%
  select(Library_ID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_base <- ggplot(mpa3_species_decontam_top50_each_clr_long, aes(Library_ID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 11) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base


# ggsave("./05-results.backup/top50species_each_heatmap.pdf", plot = heatmap_base, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

```


```{r, eval = F}

test_file <- mpa3_species_raw %>%
  select(matches("Species|ELR|IVE")) %>%
  adorn_totals(where = "col") %>%
  filter(Total > 0)

```

```{r plot_test}
full_metadata %>%
  filter(str_detect(Library_ID, "MID")) %>%
  drop_na(Pipenotch) %>%
  ggplot(., aes(x = factor(Max_Perio_Score), y = Age, color = Sex, shape = Pipenotch, size = `%AMTL`)) +
    ggpointgrid::geom_pointrect(scale_x = 0.16, scale_y = 0.18) +
    theme_minimal() +
    scale_shape_manual(values = c(12, 7)) +
    theme(axis.text = element_text(size = 10)) +
    xlab("Max. periodontitis score") +
    ylab("Age group")

```




























