---
title: "MID/CMB, Radcliffe, Kilteasheen, Iberian Medieval, calculus MetaPhlAn3 beta diversity"
author: "Irina Velsko"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
    github_document:
        fig_width: 8
        fig_height: 6
        toc: true
---


```{r load_libraries, echo = F, message = F}
library(knitr)
library(data.table)
library(psych)
library(ape)
library(mixOmics)
library(compositions)
library(vegan)
library(janitor)
library(pander)
library(tidyverse)
library(gplots)
library(ggrepel)
library(viridis)
library(cowplot)
opts_chunk$set(echo=F, warning=F, message=F, dpi=150)
```

Set the working directory of the notebook to the parent directory of the 
notebook itself.  

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

# MetaPhlAn3

```{r load_data}
# read in the species table
mpa3_raw <- fread("./05-results.backup/abundance_table_mpa3.tsv") %>%
  select(-NCBI_tax_id)

# clean the file names
colnames(mpa3_raw) <- gsub(".metaphlan3","", colnames(mpa3_raw))

# filter to have only species
mpa3_sp <- mpa3_raw %>% 
  filter(str_detect(clade_name, "s__")) %>%
  separate(clade_name, into = c("K","P","C","O","F","G","Species"), sep = "\\|") %>%
  select(-c("K","P","C","O","F","G")) %>%
  mutate(Species = str_replace_all(Species, "s__",""),
         Species = str_replace_all(Species, "_"," ")) %>%
  # these samples have no metadata
  select(-c("MID025.A0101","MID033.A0101","MID052.A0101","MID056.A0101","MID065.A0101","MID068.A0101","MID076.A0101","MID078.A0101")) %>%
  arrange(Species)

```


Now decontam the tables
```{r}
mpa3_contaminants <- fread("./05-results.backup/contaminant_species_mid_mpa3.tsv", sep = "\t") %>%
  bind_rows(., fread("./05-results.backup/contaminant_species_kilteasheen_mpa3.tsv", sep = "\t")) %>%
  bind_rows(., fread("./05-results.backup/contaminant_species_iberia_mpa3.tsv", sep = "\t")) %>%
  unique()

# remove contaminant species from nt table
mpa3_species_decontam <- mpa3_sp %>%
  anti_join(., mpa3_contaminants)

```

```{r load_strep_groups}
strep_groups <- fread("./00-documentation.backup/25-streptococcus_cladegroup_amylasegroup_database.tsv") %>%
  select(Taxon, Clade_Consensus) %>%
  rename(Species = Taxon) %>%
  mutate(Species = str_replace_all(Species, "_", " ")) %>%
  rename(Strep_group = Clade_Consensus) %>%
  mutate(Strep_group = fct_relevel(Strep_group, "sanguinis","mitis","salivarius","anginosus","bovis","pyogenic","mutans","unknown","NA"))

# get the proportion of sanguinis and anginosis for each sample
strep_group_info <- mpa3_species_decontam %>%
  filter(str_detect(Species, "Streptococcus")) %>%
  # join with the Strep grup table for plotting
  inner_join(., strep_groups) %>%
  select(-Species) %>%
  select(Strep_group, everything()) %>%
  # transpose
  gather("Library_ID","Counts", 2:ncol(.)) %>%
  group_by(Library_ID, Strep_group) %>%
  summarize(Reads = sum(Counts)) %>%
  spread(Strep_group, Reads) %>%
  # convert table to proportions
  adorn_percentages(denominator = "row") %>%
  # arrange by sanguinis and for the ones w/o sanguinis, by anginosis
  arrange(desc(sanguinis))

```

```{r load_metadata}

# load the metadata file
load("./05-results.backup/Metadata_tables.RData")

# read in the MALT mapped/unmapped gc and read length info from `MID_malt_map_unmap_rl_gc.Rmd`
malt_map_unmap_rl_gc <- fread("./05-results.backup/rl_gc_sub_data.tsv")
colnames(malt_map_unmap_rl_gc) <- gsub("_map","_malt_map", colnames(malt_map_unmap_rl_gc))
colnames(malt_map_unmap_rl_gc) <- gsub("_unmap","_malt_unmap", colnames(malt_map_unmap_rl_gc))

# full_metadata <- full_metadata %>%
#   mutate(`DNA_molecules_per_library_x10^6_log` = log10(`DNA_molecules_per_library_x10^6`)) %>%
#   full_join(., malt_map_unmap_rl_gc) %>%
#   full_join(., strep_groups, by = "Library_ID")

```



```{r pca_name_fxn}
# this function plots the PCA with the sample names instead of points
plot_pca_names <- function(df, pc1, pc2, metadata_group) {
    metadata_group_colors <- get(paste(metadata_group, "_colors", sep = ""))

    exp_var <- paste0(round(df$explained_variance * 100, 2), "%")
    df_X <- df$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("Library_ID") %>%
              inner_join(full_metadata %>%
                         select(Library_ID, Site, Region, Time_period, Sample_or_Control, Periodontal_disease_present, Caries_present, Sex, Age, Tooth_location), by = "Library_ID") %>%
              inner_join(., strep_group_info)
    
    metadata_group = df_X[[metadata_group]]
    
    if (pc1 == 'PC1') {
        pc1 <- df_X$PC1
        exp_var_pc1 <- exp_var[1]
        xaxis <- c("PC1")
    }  else if (pc1 == 'PC2') {
        pc1 <- df_X$PC2
        exp_var_pc1 <- exp_var[2]
        xaxis <- c("PC2")
    } else if (pc1 == 'PC3') {
        pc1 <- df_X$PC3
        exp_var_pc1 <- exp_var[3]
        xaxis <- c("PC3")
    }

    if (pc2 == 'PC1') {
        pc2 <- df_X$PC1
        exp_var_pc2 <- exp_var[1]
        yaxis <- c("PC1")
    }  else if (pc2 == 'PC2') {
        pc2 <- df_X$PC2
        exp_var_pc2 <- exp_var[2]
        yaxis <- c("PC2")
    } else if (pc2 == 'PC3') {
        pc2 <- df_X$PC3
        exp_var_pc2 <- exp_var[3]
        yaxis <- c("PC3")
    }

    pca_plot_names <- ggplot(df_X, aes(pc1, pc2, colour = metadata_group)) +
     geom_text(aes(label = df_X$Library_ID), size = 4) +
     scale_colour_manual(values = metadata_group_colors) +
     # stat_ellipse() +
     xlab(paste(xaxis, " - ", exp_var_pc1)) +
     ylab(paste(yaxis, " - ", exp_var_pc2)) +
     theme_minimal(base_size = 16) +
     theme(text = element_text(size=16)) +
     theme(legend.position = "top") 
    # +
    #                     theme(legend.title = element_blank())

    return(pca_plot_names)
}

```

```{r pca_plot_fxn}
# plot PCA with colored dots and the title including the # of species or genera
plot_pca <- function(df, pc1, pc2, color_group, shape_group, ncomps) {
    metadata_group_colors <- get(paste(color_group, "_colors", sep = ""))
    metadata_group_shapes <- get(paste(shape_group, "_shapes", sep = ""))

    pca.list <- mixOmics::pca(df, ncomp = ncomps, logratio = 'CLR')

    exp_var <- paste0(round(pca.list$explained_variance * 100, 2), "%")
    df_X <- pca.list$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("Library_ID") %>%
              inner_join(full_metadata, by = "Library_ID") %>%
              inner_join(., strep_group_info)
              
    color_group = df_X[[color_group]]
    shape_group = df_X[[shape_group]]

    if (pc1 == 'PC1') {
        pc1 <- df_X$PC1
        exp_var_pc1 <- exp_var[1]
        xaxis <- c("PC1")
    }  else if (pc1 == 'PC2') {
        pc1 <- df_X$PC2
        exp_var_pc1 <- exp_var[2]
        xaxis <- c("PC2")
    } else if (pc1 == 'PC3') {
        pc1 <- df_X$PC3
        exp_var_pc1 <- exp_var[3]
        xaxis <- c("PC3")
    }

    if (pc2 == 'PC1') {
        pc2 <- df_X$PC1
        exp_var_pc2 <- exp_var[1]
        yaxis <- c("PC1")
    }  else if (pc2 == 'PC2') {
        pc2 <- df_X$PC2
        exp_var_pc2 <- exp_var[2]
        yaxis <- c("PC2")
    } else if (pc2 == 'PC3') {
        pc2 <- df_X$PC3
        exp_var_pc2 <- exp_var[3]
        yaxis <- c("PC3")
    }

    pca_plot <- ggplot(df_X, aes(pc1, pc2, colour = color_group, shape = shape_group)) +
     geom_point(size = 2) +
     scale_colour_manual(values = metadata_group_colors) +
     scale_shape_manual(values = metadata_group_shapes) +
     # stat_ellipse() +
     xlab(paste(xaxis, " - ", exp_var_pc1)) +
     ylab(paste(yaxis, " - ", exp_var_pc2)) +
     theme_minimal(base_size = 16) +
     theme(text = element_text(size=16)) +
     theme(legend.title = element_blank(),
           legend.key.size = unit(2,"mm"),
           legend.text = element_text(size = 6)) +
     theme(legend.position = "top")

    return(pca_plot)
}

```

```{r pca_plot_mid_fxn}
# plot PCA with colored dots 
plot_pca_mid <- function(df, pc1, pc2, color_group, shape_group, ncomps, title_text) {

    pca.list <- mixOmics::pca(df, ncomp = ncomps, logratio = 'CLR')

    exp_var <- paste0(round(pca.list$explained_variance * 100, 2), "%")
    df_X <- pca.list$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("Library_ID") %>%
              inner_join(full_metadata, by = "Library_ID")
    
    color_group = df_X[[color_group]]
    shape_group = df_X[[shape_group]]

    if (pc1 == 'PC1') {
        pc1 <- df_X$PC1
        exp_var_pc1 <- exp_var[1]
        xaxis <- c("PC1")
    }  else if (pc1 == 'PC2') {
        pc1 <- df_X$PC2
        exp_var_pc1 <- exp_var[2]
        xaxis <- c("PC2")
    } else if (pc1 == 'PC3') {
        pc1 <- df_X$PC3
        exp_var_pc1 <- exp_var[3]
        xaxis <- c("PC3")
    }

    if (pc2 == 'PC1') {
        pc2 <- df_X$PC1
        exp_var_pc2 <- exp_var[1]
        yaxis <- c("PC1")
    }  else if (pc2 == 'PC2') {
        pc2 <- df_X$PC2
        exp_var_pc2 <- exp_var[2]
        yaxis <- c("PC2")
    } else if (pc2 == 'PC3') {
        pc2 <- df_X$PC3
        exp_var_pc2 <- exp_var[3]
        yaxis <- c("PC3")
    }

    pca_plot <- ggplot(df_X, aes(pc1, pc2, colour = color_group, shape = shape_group)) +
     geom_point(size = 2) +
     scale_colour_manual(values = c("#5A167E","#E95562","#FED395","#252525","#311068","#C83E73","#FEA873")) + # 
     scale_shape_manual(values = c(16, 17, 15, 18)) +
     # stat_ellipse() +
     xlab(paste(xaxis, " - ", exp_var_pc1)) +
     ylab(paste(yaxis, " - ", exp_var_pc2)) +
     theme_minimal(base_size = 16) +
     theme(text = element_text(size=16)) +
     theme(legend.title = element_blank(),
           legend.key.size = unit(2,"mm"),
           legend.text = element_text(size = 6)) + # 
     theme(legend.position = "top") +
     ggtitle(title_text) + theme(plot.title = element_text(size = 10))

    return(pca_plot)
}

```

```{r pca_plot_cont_fxn}
# for continuous data
plot_pca_cont <- function(df, pc1, pc2, color_group, shape_group, ncomps, title_text) {

    pca.list <- mixOmics::pca(df, ncomp = ncomps, logratio = 'CLR')

    exp_var <- paste0(round(pca.list$explained_variance * 100, 2), "%")
    df_X <- pca.list$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("Library_ID") %>%
              inner_join(full_metadata, by = "Library_ID") %>%
              inner_join(., strep_group_info, by = "Library_ID")
    # %>%
              # full_join(., full_source_results %>%
              #             rename(Library_ID = SampleID),  by = "Library_ID")
    
    color_group = df_X[[color_group]]
    shape_group = df_X[[shape_group]]

    if (pc1 == 'PC1') {
        pc1 <- df_X$PC1
        exp_var_pc1 <- exp_var[1]
        xaxis <- c("PC1")
    }  else if (pc1 == 'PC2') {
        pc1 <- df_X$PC2
        exp_var_pc1 <- exp_var[2]
        xaxis <- c("PC2")
    } else if (pc1 == 'PC3') {
        pc1 <- df_X$PC3
        exp_var_pc1 <- exp_var[3]
        xaxis <- c("PC3")
    }

    if (pc2 == 'PC1') {
        pc2 <- df_X$PC1
        exp_var_pc2 <- exp_var[1]
        yaxis <- c("PC1")
    }  else if (pc2 == 'PC2') {
        pc2 <- df_X$PC2
        exp_var_pc2 <- exp_var[2]
        yaxis <- c("PC2")
    } else if (pc2 == 'PC3') {
        pc2 <- df_X$PC3
        exp_var_pc2 <- exp_var[3]
        yaxis <- c("PC3")
    }

    pca_plot <- ggplot(df_X, aes(pc1, pc2, colour = color_group, shape = shape_group)) +
     geom_point(size = 2) +
     scale_colour_viridis_c(option = "C") +
     scale_shape_manual(values = c(16, 17, 15, 18, 14,9)) +
     # stat_ellipse() +
     xlab(paste(xaxis, " - ", exp_var_pc1)) +
     ylab(paste(yaxis, " - ", exp_var_pc2)) +
     theme_minimal(base_size = 16) +
     theme(text = element_text(size=16)) +
     theme(legend.title = element_blank(),
           legend.key.size = unit(2,"mm"),
           legend.text = element_text(size = 6)) + 
     theme(legend.position = "top") +
     ggtitle(title_text) + theme(plot.title = element_text(size = 10))

    return(pca_plot)
}


```

```{r pca_biplot_fxn}
plot_pca_bi <- function(df, pc1, pc2, metadata_group, columntitle) {
    metadata_group_colors <- get(paste(metadata_group, "_colors", sep = ""))
    metadata_group_shapes <- get(paste(metadata_group, "_shapes", sep = ""))
   
    arrow_pc <- enquo(columntitle)
    
    exp_var <- paste0(round(df$explained_variance * 100, 2), "%") # explained variance for x- and y-labels
    
    # select only the PCs from the PCA and add metadata
    df_X <- df$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("Library_ID") %>%
              inner_join(full_metadata, by = "Library_ID")
    
    metadata_group = df_X[[metadata_group]]
    
    corr_lam <- df$sdev[c("PC1", "PC2", "PC3")] * sqrt(nrow(df_X))

    df_X <- df_X %>%
      mutate(PC1 = PC1 / corr_lam[1],
             PC2 = PC2 / corr_lam[2], 
             PC3 = PC3 / corr_lam[3])

    # select the correct PC column and explained variance for PC1
    if (pc1 == 'PC1') {
        Pc1 <- df_X$PC1
        exp_var_pc1 <- exp_var[1]
        xaxis <- c("PC1")
    } else if (pc1 == 'PC2') {
        Pc1 <- df_X$PC2
        exp_var_pc1 <- exp_var[2]
        xaxis <- c("PC2")
    } else if (pc1 == 'PC3') {
        Pc1 <- df_X$PC3
        exp_var_pc1 <- exp_var[3]
        xaxis <- c("PC3")
   }
    
    # select the correct PC column and explained variance for PC2
    if (pc2 == 'PC1') {
        Pc2 <- df_X$PC1
        exp_var_pc2 <- exp_var[1]
        yaxis <- c("PC1")
 } else if (pc2 == 'PC2') {
       Pc2 <- df_X$PC2
       exp_var_pc2 <- exp_var[2]
       yaxis <- c("PC2")
    } else if (pc2 == 'PC3') {
       Pc2 <- df_X$PC3
       exp_var_pc2 <- exp_var[3]
       yaxis <- c("PC3")
   }
    
    # Identify the 10 pathways that have highest positive and negative loadings in the selected PC
    pws_10 <- df$loadings$X %>%
      as.data.frame(.) %>%
      rownames_to_column(var = "Taxon") %>%
      top_n(10, !!arrow_pc)

    neg_10 <- df$loadings$X %>%
      as.data.frame(.) %>%
      rownames_to_column(var = "Taxon") %>%
      top_n(-10, !!arrow_pc)


    pca_plot_bi <- ggplot(df_X, aes(x = Pc1, y = Pc2, colour = metadata_group)) +
      geom_point(size = 2.5, aes(shape = metadata_group) )+
      geom_segment(data = pws_10,
                   aes(xend = get(paste(pc1)), yend = get(paste(pc2))),
                   x = 0, y = 0, colour = "black",
                   size = 0.5,
                   arrow = arrow(length = unit(0.03, "npc"))) +
      geom_label_repel(data = pws_10,
                   aes(x = get(paste(pc1)), y = get(paste(pc2)), label = Taxon),
                   size = 2.5, colour = "grey20", label.padding = 0.2) +
      geom_segment(data = neg_10,
                   aes(xend = get(paste(pc1)), yend = get(paste(pc2))),
                   x = 0, y = 0, colour = "grey50",
                   size = 0.5,
                   arrow = arrow(length = unit(0.03, "npc"))) +
      geom_label_repel(data = neg_10,
                   aes(x = get(paste(pc1)), y = get(paste(pc2)), label = Taxon),
                   size = 2.5, colour = "grey20", label.padding = 0.2) +
      labs(x = paste(xaxis, " - ", exp_var_pc1),
           y = paste(yaxis, " - ", exp_var_pc2)) +
      scale_colour_manual(values = metadata_group_colors) +
      scale_shape_manual(values = metadata_group_shapes) +
      theme_minimal() + theme(text = element_text(size = 16)) +
      theme(text = element_text(size=16)) +
      theme(legend.position = "top")

    return(pca_plot_bi)
}

# pca_test_biplot <- plot_pca_bi(malt_species.pca, "PC3", "PC2", "Village", PC2)
# pca_test_biplot


```

```{r pca_lm_biplot_fxn}
plot_pca_bi_lm <- function(df, metadata_table, pc1, pc2, metadata_group, columntitle) {
    metadata_group_colors <- get(paste(metadata_group, "_colors", sep = ""))
    metadata_group_shapes <- get(paste(metadata_group, "_shapes", sep = ""))
   
    arrow_pc <- enquo(columntitle)
    
    exp_var <- paste0(round(df$explained_variance * 100, 2), "%") # explained variance for x- and y-labels
    
    # select only the PCs from the PCA and add metadata
    df_X <- df$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("Library_ID") %>%
              inner_join(metadata_table, by = "Library_ID")
    
    metadata_group = df_X[[metadata_group]]
    
    corr_lam <- df$sdev[c("PC1", "PC2", "PC3")] * sqrt(nrow(df_X))

    df_X <- df_X %>%
      mutate(PC1 = PC1 / corr_lam[1],
             PC2 = PC2 / corr_lam[2], 
             PC3 = PC3 / corr_lam[3])

    # select the correct PC column and explained variance for PC1
    if (pc1 == 'PC1') {
        Pc1 <- df_X$PC1
        exp_var_pc1 <- exp_var[1]
        xaxis <- c("PC1")
    } else if (pc1 == 'PC2') {
        Pc1 <- df_X$PC2
        exp_var_pc1 <- exp_var[2]
        xaxis <- c("PC2")
    } else if (pc1 == 'PC3') {
        Pc1 <- df_X$PC3
        exp_var_pc1 <- exp_var[3]
        xaxis <- c("PC3")
   }
    
    # select the correct PC column and explained variance for PC2
    if (pc2 == 'PC1') {
        Pc2 <- df_X$PC1
        exp_var_pc2 <- exp_var[1]
        yaxis <- c("PC1")
 } else if (pc2 == 'PC2') {
       Pc2 <- df_X$PC2
       exp_var_pc2 <- exp_var[2]
       yaxis <- c("PC2")
    } else if (pc2 == 'PC3') {
       Pc2 <- df_X$PC3
       exp_var_pc2 <- exp_var[3]
       yaxis <- c("PC3")
   }
    
    # Identify the 10 pathways that have highest positive and negative loadings in the selected PC
    pws_10 <- df$loadings$X %>%
      as.data.frame(.) %>%
      rownames_to_column(var = "Taxon") %>%
      top_n(10, !!arrow_pc)

    neg_10 <- df$loadings$X %>%
      as.data.frame(.) %>%
      rownames_to_column(var = "Taxon") %>%
      top_n(-10, !!arrow_pc)


    pca_plot_bi <- ggplot(df_X, aes(x = Pc1, y = Pc2, colour = metadata_group)) +
      geom_point(size = 2.5, aes(shape = metadata_group) )+
      geom_segment(data = pws_10,
                   aes(xend = get(paste(pc1)), yend = get(paste(pc2))),
                   x = 0, y = 0, colour = "black",
                   size = 0.5,
                   arrow = arrow(length = unit(0.03, "npc"))) +
      geom_label_repel(data = pws_10,
                   aes(x = get(paste(pc1)), y = get(paste(pc2)), label = Taxon),
                   size = 2.5, colour = "grey20", label.padding = 0.2) +
      geom_segment(data = neg_10,
                   aes(xend = get(paste(pc1)), yend = get(paste(pc2))),
                   x = 0, y = 0, colour = "grey50",
                   size = 0.5,
                   arrow = arrow(length = unit(0.03, "npc"))) +
      geom_label_repel(data = neg_10,
                   aes(x = get(paste(pc1)), y = get(paste(pc2)), label = Taxon),
                   size = 2.5, colour = "grey20", label.padding = 0.2) +
      labs(x = paste(xaxis, " - ", exp_var_pc1),
           y = paste(yaxis, " - ", exp_var_pc2)) +
      scale_colour_manual(values = metadata_group_colors) +
      scale_shape_manual(values = metadata_group_shapes) +
      theme_minimal() + theme(text = element_text(size = 16)) +
      theme(text = element_text(size=16)) +
      theme(legend.position = "top")

    return(pca_plot_bi)
}

# pca_test_biplot <- plot_pca_bi(malt_species.pca, "PC3", "PC2", "Village", PC2)
# pca_test_biplot


```


List the outliers from the plot in `MID_CMB_Rad_Kil_Iber_decontam.Rmd`. 
```{r outliers}
outliers_mpa3 <- c("EXB059.A2101","EXB059.A2501","EXB015.A3301","EXB034.A2701","EXB059.A2201","EXB059.A2301","EXB059.A2401","LIB058.A0103","LIB058.A0106","LIB058.A0104")
poor_samples_mpa3 <- fread("./05-results.backup/cuperdec_mpa3_poor_samples.tsv") %>%
  pull(Sample)

outliersF <- str_c(outliers_mpa3, collapse = "|")

```


#Sample Clustering with PCA

Step-by-step removal of taxa based on decontam and a filter threshold, followed
by PCA to see how contaminants/low abundance species affect the relationships of
samples to eachother between groups.
```{r pca_all_species}
# decontaminated only
mpa3_species_decontam_unfilt <- mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(-matches("ARS|CSS|CSL")) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts +1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("Library_ID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.pca(mpa3_species_decontam_unfilt, logratio = 'CLR')

# perform and plot a PCA to see how the data cluster
plot_pca(mpa3_species_decontam_unfilt, "PC1", "PC2", "Site", "Time_period", 3)
plot_pca(mpa3_species_decontam_unfilt, "PC3", "PC2", "Site", "Time_period", 3)


```


# Species-level analyses
What is the relationship of the groups in a PCA without the blanks? Let's try
the PCA using only the species that are present in at least 10% of at least one
sample group (MID, CMB, Radcliffe, Kilteasheen, Iberia)

```{r}

# decontaminated only
mpa3_species_decontam_unfilt <- mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(-matches("EXB|LIB|CSN|CSD|ARS|CSS|CSL")) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts +1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("Library_ID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.pca(mpa3_species_decontam_unfilt, logratio = 'CLR')

# perform and plot a PCA to see how the data cluster
plot_pca(mpa3_species_decontam_unfilt, "PC1", "PC2", "Site", "Time_period", 3)
plot_pca(mpa3_species_decontam_unfilt, "PC3", "PC2", "Site", "Time_period", 3)

```

```{r biplots_all_species}

mpa3_species_decontam_unfilt <- mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(-matches("EXB|LIB|CSN|CSD|ARS|CSS|CSL")) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts +1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("Library_ID")

mpa3_species_decontam_unfilt.pca <- mixOmics::pca(mpa3_species_decontam_unfilt, ncomp = 3, logratio = 'CLR')
plot(mpa3_species_decontam_unfilt.pca)

# Define pipenotch colors for plotting
Pipenotch_colors = c("#311068","#C83E73")
Pipenotch_shapes = c(19,17)

mpa3_species_decontam_filtered_nocontrols_biplot_121 <- plot_pca_bi(mpa3_species_decontam_unfilt.pca, "PC1", "PC2", "Site", PC1)
mpa3_species_decontam_filtered_nocontrols_biplot_121

mpa3_species_decontam_filtered_nocontrols_biplot_122 <- plot_pca_bi(mpa3_species_decontam_unfilt.pca, "PC1", "PC2", "Site", PC2)
mpa3_species_decontam_filtered_nocontrols_biplot_122

pandoc.table(mpa3_species_decontam_filtered_nocontrols_biplot_121$plot_env$pws_10 %>% arrange(desc(PC1)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lccr",
             split.tables = Inf,
             caption = "PC1 positive loadings")

pandoc.table(mpa3_species_decontam_filtered_nocontrols_biplot_121$plot_env$neg_10 %>% arrange(PC1),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lccr",
             split.tables = Inf,
             caption = "PC1 negative loadings")


pandoc.table(mpa3_species_decontam_filtered_nocontrols_biplot_122$plot_env$pws_10 %>% arrange(desc(PC2)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lccr",
             split.tables = Inf,
             caption = "PC2 positive loadings")

pandoc.table(mpa3_species_decontam_filtered_nocontrols_biplot_122$plot_env$neg_10 %>% arrange(PC2),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lccr",
             split.tables = Inf,
             caption = "PC2 negative loadings")


mpa3_species_decontam_filtered_nocontrols_biplot_322 <- plot_pca_bi(mpa3_species_decontam_unfilt.pca, "PC3", "PC2", "Site", PC2)
mpa3_species_decontam_filtered_nocontrols_biplot_322

mpa3_species_decontam_filtered_nocontrols_biplot_323 <- plot_pca_bi(mpa3_species_decontam_unfilt.pca, "PC3", "PC2", "Site", PC3)
mpa3_species_decontam_filtered_nocontrols_biplot_323

pandoc.table(mpa3_species_decontam_filtered_nocontrols_biplot_323$plot_env$pws_10 %>% arrange(desc(PC3)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lccr",
             split.tables = Inf,
             caption = "PC3 positive loadings")

pandoc.table(mpa3_species_decontam_filtered_nocontrols_biplot_323$plot_env$neg_10 %>% arrange(PC3),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lccr",
             split.tables = Inf,
             caption = "PC3 negative loadings")

```

```{r pca_species_mid_pc12}
mpa3_species_decontam_unfilt <- mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(-matches("EXB|LIB|CSN|CSD|ARS|CSS|CSL")) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts +1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("Library_ID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
mixOmics::tune.pca(mpa3_species_decontam_unfilt, logratio = 'CLR')


mpa3_all_otu.pca <- mixOmics::pca(mpa3_species_decontam_unfilt, ncomp = 2, logratio = 'CLR')
mpa3_all_pca_values <- mpa3_all_otu.pca$variates$X %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  inner_join(., full_metadata, by = "Library_ID")

ggplot(mpa3_all_pca_values, aes(PC1, PC2, color = Region, shape = Region)) +
  geom_point(size = 2) +
  geom_text(aes(label = Library_ID), size = 3) +
  theme_minimal() +
  scale_color_manual(values = Region_colors)

# check if the Radliffe samples separate by characteristics of the calculus deposits, Deposit_density, Deposit_location, Deposit_spread
ggplot(mpa3_all_pca_values, aes(PC1, PC2, color = Deposit_spread, shape = Region)) +
  geom_point(size = 2) +
  # geom_text(aes(label = Library_ID), size = 3) +
  theme_minimal() 

# perform and plot a PCA to see how the data cluster
# by sequencing depth 
mid_seqdepth_pc12 <- plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "No_reads_total", "Site", 3, "Total reads into MetaPhlAn3")
mid_seqdepth_pc12
# ggsave("~/Desktop/MID_pca_mid_seqdepth_pc12.pdf", plot = mid_seqdepth_pc12, device = "pdf",
#        scale = 1, width = 9, height = 5, units = c("in"), dpi = 300)

# by average GC content
plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "gc_avg", "Site", 3, "Avg. GC content (%)")

# by average read length
plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "seq_len_avg", "Time_period", 3, "Avg. read length (bp)")

```

```{r}
# linear modeling to control for GC content along PC2
# by Ainash

head(mpa3_all_pca_values)

length(mpa3_all_pca_values$Time_period)

# summary(lm(PC2 ~ factor(Time_period) + gc_avg , data = mpa3_all_pca_values))
summary(lm(PC2 ~ gc_avg , data = mpa3_all_pca_values))

model <- lm(PC2 ~ gc_avg , data = mpa3_all_pca_values)

resid(model)

pc2_resid <- as.data.frame(model$residuals)

ggplot(mpa3_all_pca_values, aes(PC1, pc2_residuals, colour = gc_avg, shape = Site, size = Site)) +
  geom_point() +
  scale_shape_manual(values = Site_shapes) +
  scale_colour_viridis_c(option = "C") +
  # scale_color_manual(values = Site_colors) +
  scale_size_manual(values = c(2,2,2,3,2,2)) +
   # stat_ellipse() +
  # xlab(paste(exp_var[1], " - ", exp_var_pc1)) +
  # ylab(paste(exp_var[2], " - ", exp_var_pc2)) +
  theme_minimal(base_size = 16) +
  theme(text = element_text(size=16)) +
  theme(legend.title = element_blank(),
        legend.key.size = unit(2,"mm"),
        legend.text = element_text(size = 6)) +
  theme(legend.position = "top")


```

```{r}

# Extract coordinates from mixOmics object and convert into long table dataframe
mpa3_all_pca_values_short <- mpa3_all_pca_values %>%
  select(Library_ID,gc_avg,PC1,PC2,pc2_residuals, Site)
# Extract explained variance
pca_expl_vars <- paste0(round(mpa3_all_otu.pca$explained_variance * 100, 2), "%")
# Extract loadings (eigenvectors) from PC analysis
pca_loadings_df <- as.data.frame(mpa3_all_otu.pca$loadings$X) %>%
  rownames_to_column(var = "Species")
# Identify the 10 species that have highest positive and negative loadings in PC1 and PC2
pc1_pws <- pca_loadings_df %>%
  top_n(10, PC1)
pc1_neg <- pca_loadings_df %>%
  top_n(-10, PC1) 
pc2_pws <- pca_loadings_df %>%
  top_n(10, PC2)
pc2_neg <- pca_loadings_df %>%
  top_n(-10, PC2) 
# Calculate correction factor for coordinate systems of principal coordinates
# so that they have the same units as the rotations of PC1 and PC2; from
# ggfortify::autoplot
corr_lam <- mpa3_all_otu.pca$sdev[c("PC1", "PC2")] * sqrt(nrow(mpa3_all_pca_values_short))
# Plot the top 10 negative and positive paths that are strongest loading in PC1 
residuals_pc2_plot_bi <- mpa3_all_pca_values_short %>%
  mutate(PC1 = PC1 / corr_lam[1],
         pc2_residuals = pc2_residuals / corr_lam[2]) %>%
  ggplot(.,
         aes(x = PC1, y = pc2_residuals, colour = gc_avg)) +
  geom_point(size = 2, aes(shape = Site)) +
  geom_segment(data = pc1_pws,
               aes(xend = PC1, yend = PC2),
               x = 0, y = 0, colour = "black", size = 0.5,
               arrow = arrow(length = unit(0.03, "npc"))) +
  geom_label_repel(data = pc1_pws,
                   aes(x = PC1, y = PC2, label = Species),
                   size = 2.5, colour = "black", label.padding = 0.2) +
  geom_segment(data = pc1_neg,
               aes(xend = PC1, yend = PC2),
               x = 0, y = 0, colour = "grey50", size = 0.5,
               arrow = arrow(length = unit(0.03, "npc"))) +
  geom_label_repel(data = pc1_neg,
                   aes(x = PC1, y = PC2, label = Species),
                   size = 2.5, colour = "black", label.padding = 0.2) +
  labs(x = paste("PC1 -", pca_expl_vars[1]),
       y = paste("PC2 -", pca_expl_vars[2])) +
  scale_colour_viridis(option = "C") +
  # scale_shape_manual(values = Site_colors) +
  theme_minimal() + theme(text = element_text(size = 14))
residuals_pc2_plot_bi

```

## Middenbeemster samples only
What is the relationship of Cameroon plaque samples to eachother without any
other sample types? Do they cluster by any of the metadata categories?
Filter the species table by % abundance
```{r pca_species_mid_pc12}
mpa3_species_decontam_unfilt <- mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(matches("Species|MID|CMB")) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>% 
  mutate(Counts = Counts +1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("Library_ID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
mixOmics::tune.pca(mpa3_species_decontam_unfilt, logratio = 'CLR')


malt_otu.pca <- mixOmics::pca(mpa3_species_decontam_unfilt, ncomp = 2, logratio = 'CLR')
malt_pca_values <- malt_otu.pca$variates$X %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  inner_join(., full_metadata, by = "Library_ID")

ggplot(malt_pca_values, aes(PC1, PC2, color = Region, shape = Region)) +
  geom_text(aes(label = Library_ID), size = 3) +
  theme_minimal()

# perform and plot a PCA to see how the data cluster
# by pipe notch presence
mid_pipe_pc12 <- plot_pca_mid(mpa3_species_decontam_unfilt, "PC1", "PC2", "Pipenotch", "Pipenotch", 3, "Pipe notch")
mid_pipe_pc12
# ggsave("~/Desktop/MID_pca_mid_pipe_pc12.pdf", plot = mid_pipe_pc12, device = "pdf",
#        scale = 1, width = 9, height = 5, units = c("in"), dpi = 300)

# by sex
plot_pca_mid(mpa3_species_decontam_unfilt, "PC1", "PC2", "Sex", "Pipenotch", 3, "Sex")

# by age
plot_pca_mid(mpa3_species_decontam_unfilt, "PC1", "PC2", "Age", "Pipenotch", 3, "Age")

# by presence of periodontal disease
plot_pca_mid(mpa3_species_decontam_unfilt, "PC1", "PC2", "Periodontal_disease_present", "Pipenotch", 3, "Periodontal disease present")

# by presence of caries
plot_pca_mid(mpa3_species_decontam_unfilt, "PC1", "PC2", "Caries_present", "Pipenotch", 3, "Caries present")

# by ante-mortem tooth loss
plot_pca_mid(mpa3_species_decontam_unfilt, "PC1", "PC2", "AMTL", "Pipenotch", 3, "AMTL")

# by supragingival calculus score
plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "calc_sup_SI_score", "Pipenotch", 3, "Sup calc SI score")

# by subgingival calculus score
plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "Calc_sub_SI_score", "Pipenotch", 3, "Sub calc SI score")

# by presence of perioapical lesions
plot_pca_mid(mpa3_species_decontam_unfilt, "PC1", "PC2", "Periapical_lesions", "Pipenotch", 3, "Periapical lesions")

# by max periodontal disease score
plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "Max_Perio_Score", "Pipenotch", 3, "Max perio score")

# by periodontal affect score
plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "Peridontal_affect_score", "Pipenotch", 3, "Perio affect score")

# by % antemortem tooth loss
plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "%AMTL", "Pipenotch", 3, " % AMTL")

# by % positions w/periapical lesions
plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "%_positions_perioapical", "Pipenotch", 3, "% positions periapical lesions")

# by % teeth with caries
plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "%teeth_with_caries", "Pipenotch", 3, "% teeth w/ caries")

# by % teeth with calculus
plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "%teeth_with_calc", "Pipenotch", 3, "% teeth w/ calc")

# by % positions with periodontal disease
plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "%_positions_with_Periodontal", "Pipenotch", 3, "% positions w/ PD")

# by minimum number of pipenotches 
mid_minpipe_pc12 <- plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "Min_no_Pipe_notches", "Pipenotch", 3, "Min # pipe notches")
mid_minpipe_pc12
# ggsave("~/Desktop/MID_pca_mid_minpipe_pc12.pdf", plot = mid_minpipe_pc12, device = "pdf",
#        scale = 1, width = 9, height = 5, units = c("in"), dpi = 300)

# by sequencing depth 
mid_seqdepth_pc12 <- plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "No_reads_total", "Pipenotch", 3, "Total reads into MetaPhlAn3")
mid_seqdepth_pc12
# ggsave("~/Desktop/MID_pca_mid_seqdepth_pc12.pdf", plot = mid_seqdepth_pc12, device = "pdf",
#        scale = 1, width = 9, height = 5, units = c("in"), dpi = 300)

# by sampled tooth site(s)
mid_tooth_pc12 <- plot_pca_mid(mpa3_species_decontam_unfilt, "PC1", "PC2", "Tooth_location", "Pipenotch", 3, "Tooth location")
mid_tooth_pc12
# ggsave("~/Desktop/MID_pca_mid_tooth_pc12.pdf", plot = mid_tooth_pc12, device = "pdf",
#        scale = 1, width = 9, height = 5, units = c("in"), dpi = 300)

# by sampled tooth site(s)
plot_pca_mid(mpa3_species_decontam_unfilt, "PC1", "PC2", "alt_tooth_location", "Pipenotch", 3, "Tooth location")

# by mg of extracted calculus
plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "Calculus_extracted_mg", "Pipenotch", 3, "Weight of extracted calculus")

# by [DNA] after extraction per mg of calculus extracted
plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "extract_conc_ng/mg", "Pipenotch", 3, "DNA extract concentration (ng/mg)")

# by [DNA] after extraction per uL of eluate
mid_extract_pc12 <- plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "extract_conc_ng/uL", "Pipenotch", 3, "DNA extract concentration (ng/uL)")
mid_extract_pc12
# ggsave("~/Desktop/MID_pca_mid_extract_pc12.pdf", plot = mid_extract_pc12, device = "pdf",
#        scale = 1, width = 9, height = 5, units = c("in"), dpi = 300)

# by soil type
plot_pca_mid(mpa3_species_decontam_unfilt, "PC1", "PC2", "Soil", "Pipenotch", 3, "Soil type")

# by average GC content
plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "gc_avg", "Time_period", 3, "Avg. GC content (%)")

# by average read length
plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "seq_len_avg", "Time_period", 3, "Avg. read length (bp)")

# by Strep group proportion - sanguinis
plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "sanguinis", "Time_period", 3, "Proportion of Sanguinis group")

# by Strep group proportion - mitis
plot_pca_cont(mpa3_species_decontam_unfilt, "PC1", "PC2", "mitis", "Time_period", 3, "Proportion of Mitis group")

# with names
# pca.list <- mixOmics::pca(mpa3_species_decontam_unfilt, ncomp = 3, logratio = 'CLR')
# plot_pca_names(pca.list, "PC1", "PC2", "Pipenotch")

# ggsave("05-results.backup/pca_mpa3_species_pc1pc2.pdf", plot = pca_mpa3_species_pc1pc2, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"),
#        dpi = 300)
```

```{r pca_species_mid_pc32}
# by sex
plot_pca_mid(mpa3_species_decontam_unfilt, "PC3", "PC2", "Sex", "Pipenotch", 3, "Sex")

# by age
plot_pca_mid(mpa3_species_decontam_unfilt, "PC3", "PC2", "Age", "Pipenotch", 3, "Age")

# by pipe notch presence
plot_pca_mid(mpa3_species_decontam_unfilt, "PC3", "PC2", "Pipenotch", "Pipenotch", 3, "Pipe notch")

# by presence of periodontal disease
plot_pca_mid(mpa3_species_decontam_unfilt, "PC3", "PC2", "Periodontal_disease_present", "Pipenotch", 3, "Periodontal disease present")

# by presence of caries
plot_pca_mid(mpa3_species_decontam_unfilt, "PC3", "PC2", "Caries_present", "Pipenotch", 3, "Caries present")

# by ante-mortem tooth loss
plot_pca_mid(mpa3_species_decontam_unfilt, "PC3", "PC2", "AMTL", "Pipenotch", 3, "AMTL")

# by supragingival calculus score
plot_pca_cont(mpa3_species_decontam_unfilt, "PC3", "PC2", "calc_sup_SI_score", "Pipenotch", 3, "Sup calc SI score")

# by subgingival calculus score
plot_pca_cont(mpa3_species_decontam_unfilt, "PC3", "PC2", "Calc_sub_SI_score", "Pipenotch", 3, "Sub calc SI score")

# by presence of perioapical lesions
plot_pca_mid(mpa3_species_decontam_unfilt, "PC3", "PC2", "Periapical_lesions", "Pipenotch", 3, "Periapical lesions")

# by max periodontal disease score
plot_pca_cont(mpa3_species_decontam_unfilt, "PC3", "PC2", "Max_Perio_Score", "Pipenotch", 3, "Max perio score")

# by periodontal affect score
plot_pca_cont(mpa3_species_decontam_unfilt, "PC3", "PC2", "Peridontal_affect_score", "Pipenotch", 3, "Perio affect score")

# by % antemortem tooth loss
plot_pca_cont(mpa3_species_decontam_unfilt, "PC3", "PC2", "%AMTL", "Pipenotch", 3, "% AMTL")

# by % positions w/periapical lesions
plot_pca_cont(mpa3_species_decontam_unfilt, "PC3", "PC2", "%_positions_perioapical", "Pipenotch", 3, "% positions periapical lesions")

# by % teeth with caries
plot_pca_cont(mpa3_species_decontam_unfilt, "PC3", "PC2", "%teeth_with_caries", "Pipenotch", 3, "% teeth w/ caries")

# by % teeth with calculus
plot_pca_cont(mpa3_species_decontam_unfilt, "PC3", "PC2", "%teeth_with_calc", "Pipenotch", 3, "% teeth w/ calc")

# by % positions with periodontal disease
plot_pca_cont(mpa3_species_decontam_unfilt, "PC3", "PC2", "%_positions_with_Periodontal", "Pipenotch", 3, "% positions w/ PD")

# by minimum number of pipenotches 
plot_pca_cont(mpa3_species_decontam_unfilt, "PC3", "PC2", "Min_no_Pipe_notches", "Pipenotch", 3, "Min # pipe notches")

# by sequencing depth 
plot_pca_cont(mpa3_species_decontam_unfilt, "PC3", "PC2", "No_reads_total", "Pipenotch", 3, "Total reads into MALT")

# by sampled tooth site(s)
plot_pca_mid(mpa3_species_decontam_unfilt, "PC3", "PC2", "Tooth_location", "Pipenotch", 3, "Tooth location")

# by sampled tooth site(s)
plot_pca_mid(mpa3_species_decontam_unfilt, "PC3", "PC2", "alt_tooth_location", "Pipenotch", 3, "Tooth location")

# by mg of extracted calculus
plot_pca_cont(mpa3_species_decontam_unfilt, "PC3", "PC2", "Calculus_extracted_mg", "Pipenotch", 3, "Weight of extracted calculus")

# by [DNA] after extraction
plot_pca_cont(mpa3_species_decontam_unfilt, "PC3", "PC2", "extract_conc_ng/mg", "Pipenotch", 3, "DNA extract concentration (ng/mg)")

# by [DNA] after extraction per uL of eluate
plot_pca_cont(mpa3_species_decontam_unfilt, "PC3", "PC2", "extract_conc_ng/uL", "Pipenotch", 3, "DNA extract concentration (ng/uL)")

# by soil type
plot_pca_mid(mpa3_species_decontam_unfilt, "PC3", "PC2", "Soil", "Pipenotch", 3, "Soil type")

# by average GC content
plot_pca_cont(mpa3_species_decontam_unfilt, "PC3", "PC2", "gc_avg", "Time_period", 33, "Avg. GC content (%)")

# by average read length
plot_pca_cont(mpa3_species_decontam_unfilt, "PC3", "PC2", "seq_len_avg", "Time_period", 33, "Avg. read length (bp)")

```



```{r biplots_mid_species}

mpa3_species_decontam_unfilt <- mpa3_species_decontam %>%
  select(-one_of(outliers_mpa3)) %>%
  select(-one_of(poor_samples_mpa3)) %>%
  select(matches("Species|MID|CMB")) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>% 
  mutate(Counts = Counts +1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("Library_ID")

mpa3_species_decontam_unfilt.pca <- mixOmics::pca(mpa3_species_decontam_unfilt, ncomp = 3, logratio = 'CLR')
plot(mpa3_species_decontam_unfilt.pca)

# Define pipenotch colors for plotting
Pipenotch_colors = c("#311068","#C83E73")
Pipenotch_shapes = c(19,17)

mpa3_species_decontam_filtered_nocontrols_biplot_121 <- plot_pca_bi(mpa3_species_decontam_unfilt.pca, "PC1", "PC2", "Pipenotch", PC1)
mpa3_species_decontam_filtered_nocontrols_biplot_121

mpa3_species_decontam_filtered_nocontrols_biplot_122 <- plot_pca_bi(mpa3_species_decontam_unfilt.pca, "PC1", "PC2", "Pipenotch", PC2)
mpa3_species_decontam_filtered_nocontrols_biplot_122

pandoc.table(mpa3_species_decontam_filtered_nocontrols_biplot_121$plot_env$pws_10 %>% arrange(desc(PC1)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lccr",
             split.tables = Inf,
             caption = "PC1 positive loadings")

pandoc.table(mpa3_species_decontam_filtered_nocontrols_biplot_121$plot_env$neg_10 %>% arrange(PC1),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lccr",
             split.tables = Inf,
             caption = "PC1 negative loadings")


pandoc.table(mpa3_species_decontam_filtered_nocontrols_biplot_122$plot_env$pws_10 %>% arrange(desc(PC2)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lccr",
             split.tables = Inf,
             caption = "PC2 positive loadings")

pandoc.table(mpa3_species_decontam_filtered_nocontrols_biplot_122$plot_env$neg_10 %>% arrange(PC2),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lccr",
             split.tables = Inf,
             caption = "PC2 negative loadings")


mpa3_species_decontam_filtered_nocontrols_biplot_322 <- plot_pca_bi(mpa3_species_decontam_unfilt.pca, "PC3", "PC2", "Pipenotch", PC2)
mpa3_species_decontam_filtered_nocontrols_biplot_322

mpa3_species_decontam_filtered_nocontrols_biplot_323 <- plot_pca_bi(mpa3_species_decontam_unfilt.pca, "PC3", "PC2", "Pipenotch", PC3)
mpa3_species_decontam_filtered_nocontrols_biplot_323

pandoc.table(mpa3_species_decontam_filtered_nocontrols_biplot_323$plot_env$pws_10 %>% arrange(desc(PC3)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lccr",
             split.tables = Inf,
             caption = "PC3 positive loadings")

pandoc.table(mpa3_species_decontam_filtered_nocontrols_biplot_323$plot_env$neg_10 %>% arrange(PC3),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lccr",
             split.tables = Inf,
             caption = "PC3 negative loadings")

```





