---
title: "MID/CMB, Radcliffe, Kilteasheen, Iberian medieval calculus MALT beta diversity"
author: "Irina Velsko"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
    github_document:
        fig_width: 8
        fig_height: 6
        toc: true
---


```{r load_libraries, echo = F, message = F}
library(knitr)
library(data.table)
library(janitor)
library(tidyverse)
library(gplots)
library(viridis)
library(cowplot)
opts_chunk$set(echo=F, warning=F, message=F, dpi=150)
```

Set the working directory of the notebook to the parent directory of the 
notebook itself.  

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

# MALT read stats

```{r load_data}

# load the taxonomy tables that have been decontaminated and the column headers are cleaned up
load("./05-results.backup/Taxonomy_tables.RData")


# load the metadata file
load("./05-results.backup/Metadata_tables.RData")

# full_metadata <- full_metadata %>%
#   mutate(`DNA_molecules_per_library_x10^6_log` = log10(`DNA_molecules_per_library_x10^6`))

```

```{r load_sourcetracker_out}
full_source_results <- fread("./05-results.backup/sink_predictions_full_sources_rarefied_51500.tsv")

reduced_source_results <- fread("./05-results.backup/sink_predictions_reduced_sources_rarefied_51500.tsv")

```

```{r set_colors}
reduced_colors <- c(modernCalculus = "#80b1d3", plaque = "#b3de69", stool = "#fb8072", skin = "#ffffb3",sediment = "#bebada",bone = "#fdb462", Unknown = "#d9d9d9")
full_colors <- c(modernCalculus = "#80b1d3", subPlaque = "#8dd3c7", supPlaque = "#b3de69", urbanGut = "#fccde5",  ruralGut = "#fb8072", skin = "#ffffb3", sediment = "#bebada", boneARS = "#fdb462", Unknown = "#d9d9d9")
```


Get the samples ordered by decreasing amount of modern calculus
```{r}
samples_order_full <- full_source_results %>%
  rename(Library_ID = SampleID) %>%
  full_join(., full_metadata %>%
              select(Library_ID, Site), by = "Library_ID") %>%
  mutate(Oral = modernCalculus + subPlaque + supPlaque) %>%
  arrange(Site, desc(Oral)) %>%
  pull(Library_ID)

samples_order_reduced <- reduced_source_results %>%
  rename(Library_ID = SampleID) %>%
  full_join(., full_metadata %>%
              select(Library_ID, Site), by = "Library_ID") %>%
  mutate(Oral = modernCalculus + plaque) %>%
  arrange(Site, desc(Oral)) %>%
  pull(Library_ID)

```


Plot bar charts
```{r}

st_full_plot_all <- full_source_results %>%
  filter(!str_detect(SampleID, outliers %>% str_c(collapse = "|"))) %>%
  filter(!str_detect(SampleID, poor_samples %>% str_c(collapse = "|"))) %>%
  gather("Sources", "Percent",2:ncol(.)) %>%
  mutate(Percent = Percent * 100) %>%
  mutate(Sources = fct_relevel(Sources, "Unknown","boneARS","sediment","skin","urbanGut","ruralGut","subPlaque","supPlaque","modernCalculus"),
         SampleID = fct_relevel(SampleID, samples_order_full)) %>%
  
  filter(!str_detect(SampleID, "CMB")) %>%
  ggplot(., aes(x = SampleID, y = Percent, fill = Sources)) +
         geom_bar(stat = "identity") + # , color = "black"
         theme_minimal(base_size = 14) +
         scale_fill_manual(values = full_colors) +
         theme(axis.text.x = element_text(angle = 90, hjust = 1),
               axis.text = element_text(size = 8)) +
         geom_hline(yintercept=75, linetype="dotted") +
         geom_hline(yintercept=90, linetype="dotted", color = "gray50") +
         # scale_y_continuous(breaks=scales::pretty_breaks(n=6)) +
         ylab("% attributed to source") +
         ggtitle("Full sources")
st_full_plot_all

ggsave("~/Desktop/MID_st_full_plot_all.pdf", plot = st_full_plot_all, device = "pdf",
       scale = 1, width = 16, height = 5, units = c("in"), dpi = 300)

```

```{r}
reduced_source_results %>%
  arrange(desc(modernCalculus)) %>%
  gather("Sources", "Percent",2:ncol(.)) %>%
  mutate(Sources = fct_relevel(Sources, "Unknown","bone","sediment","skin","stool","plaque","modernCalculus"),
         SampleID = fct_relevel(SampleID, samples_order_reduced)) %>%
  ggplot(., aes(x = SampleID, y = Percent, fill = Sources)) +
         geom_bar(stat = "identity") +
         theme_minimal(base_size = 14) +
         scale_fill_manual(values = reduced_colors) +
         theme(axis.text.x = element_text(angle = 90, hjust = 1),
               axis.text = element_text(size = 8)) +
         # scale_y_continuous(breaks=scales::pretty_breaks(n=6)) +
         geom_hline(yintercept=0.75, linetype="dotted") +
         geom_hline(yintercept=0.9, linetype="dotted", color = "gray50") +
         ylab("% attributed to source") +
         ggtitle("Reduced sources")

```

What if we look at only the MID and CMB samples, and we order them by the PCA
PC1 order?
```{r}
# prep the table

outliers <- c("EXB059.A2501","LIB058.A0103","LIB058.A0106","CSS","CSD")
poor_samples <- fread("./05-results.backup/cuperdec_poor_samples.tsv") %>%
  pull(Sample)

malt_otu_pca_table <- all_species_decontam %>%
  select(matches("Species|MID")) %>%
  select(-one_of(outliers)) %>%
  select(-one_of(poor_samples)) %>%
  gather("Library_ID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species, Counts) %>%
  column_to_rownames("Library_ID")

# perform a PCA to see how the data cluster
malt_otu.pca <- mixOmics::pca(malt_otu_pca_table, ncomp = 2, logratio = 'CLR')
malt_pca_values <- malt_otu.pca$variates$X %>%
  as.data.frame() %>%
  rownames_to_column("Library_ID") %>%
  inner_join(., full_metadata, by = "Library_ID")

mid_pc1_sample_order <- malt_pca_values %>%
  arrange(PC1) %>%
  pull(Library_ID)

ggplot(malt_pca_values, aes(PC1, PC2, color = Region, shape = Region)) +
  geom_text(aes(label = Library_ID), size = 3) +
  theme_minimal()

```

```{r}
mid_ordered <- full_source_results %>%
  filter(!str_detect(SampleID, outliers %>% str_c(collapse = "|"))) %>%
  filter(!str_detect(SampleID, poor_samples %>% str_c(collapse = "|"))) %>%
  filter(str_detect(SampleID, "MID")) %>%
  gather("Sources", "Percent",2:ncol(.)) %>%
  mutate(Percent = Percent * 100) %>%
  mutate(Sources = fct_relevel(Sources, "Unknown","boneARS","sediment","skin","urbanGut","ruralGut","subPlaque","supPlaque","modernCalculus"),
         SampleID = fct_relevel(SampleID, sample_order)) %>% # mid_pc1_sample_order
  arrange(SampleID) %>%
    ggplot(., aes(x = SampleID, y = Percent, fill = Sources)) +
         geom_bar(stat = "identity") + # , color = "black"
         theme_minimal(base_size = 14) +
         scale_fill_manual(values = full_colors) +
         theme(axis.text.x = element_text(angle = 90, hjust = 1),
               axis.text = element_text(size = 8)) +
         # scale_y_continuous(breaks=scales::pretty_breaks(n=6)) +
         ylab("% attributed to source") +
         ggtitle("Full sources")
mid_ordered

ggsave("~/Desktop/MID_st_ordered_plot_mid.pdf", plot = mid_ordered, device = "pdf",
       scale = 1, width = 10, height = 5, units = c("in"), dpi = 300)

```

```{r}
reduced_source_results %>%
  filter(str_detect(SampleID, "MID|CMB")) %>%
  gather("Sources", "Percent",2:ncol(.)) %>%
  mutate(Sources = fct_relevel(Sources, "Unknown","bone","sediment","skin","stool","plaque","modernCalculus"),
         SampleID = fct_relevel(SampleID, mid_pc1_sample_order)) %>%
  ggplot(., aes(x = SampleID, y = Percent, fill = Sources)) +
         geom_bar(stat = "identity") + # , color = "black"
         theme_minimal(base_size = 14) +
         scale_fill_manual(values = reduced_colors) +
         theme(axis.text.x = element_text(angle = 90, hjust = 1),
               axis.text = element_text(size = 8)) +
         # scale_y_continuous(breaks=scales::pretty_breaks(n=6)) +
         ylab("% attributed to source") +
         ggtitle("Reduced sources")

```

Let's look at the species going into each source. Start iwth the reduced sources for simplicity
```{r}

modernCalc_sources <- fread("~/projects1/microbiome_calculus/smoking_calculus/04-analysis/sourceTracker/shotgun/rarefied_table/shotgun_sourcetracker_table_rarefied_reduced_sources_log_20210122/full_results/sink_predictions_modernCalculus_contributions.txt") %>%
  rename(Library_ID = SampleID) %>%
  gather("Species","Percent",2:ncol(.)) %>%
  spread(Library_ID, Percent) %>%
  adorn_totals(where = "col") %>%
  filter(Total > 0) %>%
  select(-Total)

plaque_sources <- fread("~/projects1/microbiome_calculus/smoking_calculus/04-analysis/sourceTracker/shotgun/rarefied_table/shotgun_sourcetracker_table_rarefied_reduced_sources_log_20210122/full_results/sink_predictions_plaque_contributions.txt") %>%
  rename(Library_ID = SampleID) %>%
  gather("Species","Percent",2:ncol(.)) %>%
  spread(Library_ID, Percent) %>%
  adorn_totals(where = "col") %>%
  filter(Total > 0) %>%
  select(-Total)

stool_sources <- fread("~/projects1/microbiome_calculus/smoking_calculus/04-analysis/sourceTracker/shotgun/rarefied_table/shotgun_sourcetracker_table_rarefied_reduced_sources_log_20210122/full_results/sink_predictions_stool_contributions.txt") %>%
  rename(Library_ID = SampleID) %>%
  gather("Species","Percent",2:ncol(.)) %>%
  spread(Library_ID, Percent) %>%
  adorn_totals(where = "col") %>%
  filter(Total > 0) %>%
  select(-Total)

skin_sources <- fread("~/projects1/microbiome_calculus/smoking_calculus/04-analysis/sourceTracker/shotgun/rarefied_table/shotgun_sourcetracker_table_rarefied_reduced_sources_log_20210122/full_results/sink_predictions_skin_contributions.txt") %>%
  rename(Library_ID = SampleID) %>%
  gather("Species","Percent",2:ncol(.)) %>%
  spread(Library_ID, Percent) %>%
  adorn_totals(where = "col") %>%
  filter(Total > 0) %>%
  select(-Total)

sediment_sources <- fread("~/projects1/microbiome_calculus/smoking_calculus/04-analysis/sourceTracker/shotgun/rarefied_table/shotgun_sourcetracker_table_rarefied_reduced_sources_log_20210122/full_results/sink_predictions_sediment_contributions.txt") %>%
  rename(Library_ID = SampleID) %>%
  gather("Species","Percent",2:ncol(.)) %>%
  spread(Library_ID, Percent) %>%
  adorn_totals(where = "col") %>%
  filter(Total > 0) %>%
  select(-Total)

bone_sources <- fread("~/projects1/microbiome_calculus/smoking_calculus/04-analysis/sourceTracker/shotgun/rarefied_table/shotgun_sourcetracker_table_rarefied_reduced_sources_log_20210122/full_results/sink_predictions_bone_contributions.txt") %>%
  rename(Library_ID = SampleID) %>%
  gather("Species","Percent",2:ncol(.)) %>%
  spread(Library_ID, Percent) %>%
  adorn_totals(where = "col") %>%
  filter(Total > 0) %>%
  select(-Total)

unknown_sources <- fread("~/projects1/microbiome_calculus/smoking_calculus/04-analysis/sourceTracker/shotgun/rarefied_table/shotgun_sourcetracker_table_rarefied_reduced_sources_log_20210122/full_results/sink_predictions_Unknown_contributions.txt") %>%
  rename(Library_ID = SampleID) %>%
  gather("Species","Percent",2:ncol(.)) %>%
  spread(Library_ID, Percent) %>%
  adorn_totals(where = "col") %>%
  filter(Total > 0) %>%
  select(-Total)

```

Overlap between modernCalculus and unknown?
```{r}
# only in unknown sources, not also in modernCalculus
unknown_sources %>%
  select(Species) %>%
  anti_join(., modernCalc_sources %>%
              select(Species))

# in both unknown and modernCalculus
unknown_sources %>%
  select(Species) %>%
  inner_join(., modernCalc_sources %>%
              select(Species))


```

```{r}
unknown_sources %>%
    filter(str_detect(Species, "Anaerovorax")) %>%
  as_tibble()

modernCalc_sources %>%
    filter(str_detect(Species, "Anaerovorax")) %>%
  as_tibble()


```
















